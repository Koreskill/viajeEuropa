<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EuroTrip 2026 - Planner Definitivo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        winter: {
                            50: '#F8FAFC',
                            100: '#F1F5F9', 
                            800: '#1E293B',
                            900: '#0F172A',
                        },
                        warm: {
                            500: '#F59E0B', // Amber 500
                            600: '#D97706', 
                        }
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.08)',
                        'float': '0 10px 30px -5px rgba(0, 0, 0, 0.2)',
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #F8FAFC; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Modal Backdrop Fix */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }

        /* Checkbox Custom */
        .custom-checkbox input:checked + div { background-color: #F59E0B; border-color: #F59E0B; }
        .custom-checkbox input:checked + div i { display: block; }

        /* Custom Map Icons Styles */
        .custom-icon-city { z-index: 1000 !important; }
        
        /* Iconos dinámicos */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #F59E0B;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }
        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        .custom-div-icon i {
            position: absolute;
            width: 22px;
            font-size: 22px;
            left: 0;
            right: 0;
            margin: 10px auto;
            text-align: center;
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #E2E8F0;
        }
        .timeline-item:last-child .timeline-line {
            height: 20px;
        }

        /* Animación botón buscar */
        .search-here-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(-100px);
            opacity: 0;
        }
        .search-here-btn.visible {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* File Upload Zone */
        .drop-zone {
            border: 2px dashed #CBD5E1;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #F59E0B;
            background-color: #FFFBEB;
        }
        
        /* Folder Hover Effect */
        .folder-card:hover .folder-icon {
            transform: scale(1.1);
            color: #F59E0B;
        }
    </style>
</head>
<body class="text-winter-800 font-sans h-screen flex flex-col md:flex-row overflow-hidden bg-winter-50">

    <!-- =======================
         NAVEGACIÓN ESCRITORIO
    ======================== -->
    <nav class="hidden md:flex flex-col w-72 bg-white border-r border-gray-200 h-full p-6 z-30 shadow-sm shrink-0" aria-label="Menú principal">
        <div class="mb-10">
            <h1 class="font-serif text-2xl font-bold text-winter-900">EuroTrip <span class="text-warm-500">2026</span></h1>
            <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest font-semibold">Dashboard Familiar</p>
        </div>
        
        <div class="space-y-2 flex-1">
            <button onclick="router('home')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="home" aria-label="Ir a Inicio">
                <i class="fas fa-compass w-5 text-center" aria-hidden="true"></i> Explorar
            </button>
            
            <button onclick="router('itinerary')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="itinerary" aria-label="Ir a Itinerario">
                <i class="fas fa-route w-5 text-center" aria-hidden="true"></i> Itinerario
            </button>

            <button onclick="router('docs')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="docs" aria-label="Ir a Documentos">
                <i class="fas fa-folder-open w-5 text-center" aria-hidden="true"></i> Documentos
            </button>

            <button onclick="router('guide')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="guide" aria-label="Ir a Guía Práctica">
                <i class="fas fa-book-open w-5 text-center" aria-hidden="true"></i> Guía Práctica
            </button>
             <button onclick="router('map')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="map" aria-label="Ir a Mapa">
                <i class="fas fa-map w-5 text-center" aria-hidden="true"></i> Mapa
            </button>
            <button onclick="router('currency')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="currency" aria-label="Ir a Cambio">
                <i class="fas fa-money-bill-wave w-5 text-center" aria-hidden="true"></i> Cambio
            </button>
        </div>

        <div class="mt-auto pt-6 border-t border-gray-100 space-y-3">
             <button onclick="triggerMagicPrompt('Dame una frase útil en Italiano y otra en Catalán para pedir la cuenta, con pronunciación', 'Traductor')" class="w-full bg-white border border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition-all flex items-center justify-center gap-2 font-bold text-xs focus:outline-none" aria-label="Traductor Rápido">
                <i class="fas fa-language text-warm-500" aria-hidden="true"></i> Frases Útiles ✨
            </button>
             <button onclick="openChat()" class="w-full bg-winter-900 hover:bg-warm-500 text-white py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 font-bold text-sm focus:outline-none focus:ring-4 focus:ring-warm-500/50" aria-label="Abrir Asistente IA">
                <i class="fas fa-sparkles" aria-hidden="true"></i> Asistente IA
            </button>
        </div>
    </nav>

    <!-- =======================
         HEADER MÓVIL
    ======================== -->
    <header class="md:hidden bg-white/95 backdrop-blur-md border-b border-gray-100 p-4 z-20 flex justify-between items-center shrink-0 sticky top-0">
        <div>
            <h1 class="font-serif text-lg font-bold text-winter-900">EuroTrip <span class="text-warm-500">2026</span></h1>
        </div>
        <div id="countdown-mobile" class="text-[10px] font-bold bg-gray-50 text-gray-600 px-3 py-1.5 rounded-full border border-gray-200" aria-live="polite">
            Cargando...
        </div>
    </header>

    <!-- =======================
         CONTENEDOR PRINCIPAL
    ======================== -->
    <main id="app-content" class="flex-1 overflow-y-auto overflow-x-hidden relative hide-scrollbar pb-28 md:pb-10 md:px-8 max-w-full bg-winter-50">
        <!-- El contenido se inyecta aquí -->
    </main>

    <!-- =======================
         NAVEGACIÓN MÓVIL (GRID-COLS-5)
    ======================== -->
    <nav class="md:hidden bg-white/95 backdrop-blur-lg border-t border-gray-200 fixed bottom-0 w-full z-30 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.03)]" aria-label="Menú móvil">
        <div class="grid grid-cols-5 h-16 max-w-md mx-auto">
            <button onclick="router('home')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition active group" data-target="home" aria-label="Inicio">
                <i class="fas fa-compass text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Inicio</span>
            </button>
            <button onclick="router('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="itinerary" aria-label="Itinerario">
                <i class="fas fa-route text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Itinerario</span>
            </button>
             <button onclick="router('docs')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="docs" aria-label="Docs">
                <i class="fas fa-folder-open text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Docs</span>
            </button>
            <button onclick="router('map')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="map" aria-label="Mapa">
                <i class="fas fa-map text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Mapa</span>
            </button>
            <button onclick="router('guide')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="guide" aria-label="Guía">
                <i class="fas fa-book-open text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Guía</span>
            </button>
        </div>
    </nav>

    <!-- =======================
         MODALES
    ======================== -->
    
    <!-- Modal Preview -->
    <div id="preview-modal" class="fixed inset-0 z-50 modal-backdrop hidden flex items-end md:items-center justify-center transition-opacity duration-300" role="dialog" aria-modal="true">
        <div class="absolute inset-0" onclick="closePreview()"></div>
        <div class="bg-white w-full md:max-w-md md:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden transform transition-transform translate-y-full md:translate-y-0 scale-95 md:scale-100 h-[85vh] md:h-auto flex flex-col relative z-10" id="preview-card">
            <button onclick="closePreview()" class="absolute top-4 right-4 z-20 bg-black/20 hover:bg-black/40 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm transition-colors focus:outline-none" aria-label="Cerrar"><i class="fas fa-times" aria-hidden="true"></i></button>
            <div id="preview-content" class="flex-1 overflow-y-auto hide-scrollbar"></div>
        </div>
    </div>

    <!-- Modal Chat IA -->
    <div id="chat-modal" class="fixed inset-0 z-50 modal-backdrop hidden flex flex-col justify-end sm:justify-center items-center" role="dialog" aria-modal="true">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-3xl h-[90vh] sm:h-[650px] flex flex-col shadow-2xl overflow-hidden relative animate-slide-up">
            <div class="bg-white border-b border-gray-100 p-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-robot text-warm-500"></i> Asistente de Viaje</h3>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Cerrar chat"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>
            <div class="p-4 bg-white border-t border-gray-100 shrink-0">
                <form onsubmit="handleChatSubmit(event)" class="flex gap-2 relative">
                    <input type="text" id="chat-input" placeholder="Pregunta algo..." class="flex-1 bg-gray-100 border-0 rounded-full px-5 py-3 text-sm focus:ring-2 focus:ring-warm-500 outline-none text-gray-800">
                    <button type="submit" class="bg-winter-900 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-warm-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-winter-900" aria-label="Enviar mensaje"><i class="fas fa-paper-plane text-xs"></i></button>
                </form>
                <p id="api-warning" class="text-[10px] text-red-500 text-center mt-2 hidden">⚠️ API Key no configurada o inválida</p>
            </div>
        </div>
    </div>
    
    <!-- Modal Config Drive -->
    <div id="drive-modal" class="fixed inset-0 z-50 modal-backdrop hidden flex items-center justify-center p-4" role="dialog" aria-modal="true">
        <div class="absolute inset-0" onclick="document.getElementById('drive-modal').classList.add('hidden')"></div>
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden relative z-10 animate-slide-up max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-winter-50">
                <div>
                    <h3 class="font-bold text-winter-900 text-lg">Configurar Enlaces de Drive</h3>
                    <p class="text-xs text-gray-500">Vincula tus carpetas reales de Google Drive/Dropbox</p>
                </div>
                <button onclick="document.getElementById('drive-modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto" id="drive-config-list">
                <!-- Se llena dinamicamente -->
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 text-right">
                <button onclick="document.getElementById('drive-modal').classList.add('hidden')" class="bg-winter-900 text-white px-6 py-2 rounded-xl font-bold text-sm shadow hover:bg-warm-500 transition-colors">Listo</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        // 1. API KEY INTEGRADA
        const apiKey = "AIzaSyDhK8H4NFt5-_QEbRDuVOU49EOyeKM4FqM"; 

        // 2. ESTADO PERSISTENTE
        const appState = JSON.parse(localStorage.getItem('euroTripState')) || { 
            checkedItems: {},
            exchangeRates: { eurToArs: 1350, usdToArs: 1250, eurToUsd: 1.08 },
            documents: [],
            cloudLinks: {} // Nuevo: Guarda enlaces a carpetas reales
        };

        // Estado temporal para subida de archivos
        let currentUploadContext = null; 

        function saveCheckState(id, isChecked) {
            appState.checkedItems[id] = isChecked;
            saveAppState();
        }

        function saveExchangeRates(newRates) {
            appState.exchangeRates = { ...appState.exchangeRates, ...newRates };
            saveAppState();
        }

        function saveCloudLink(id, url) {
            appState.cloudLinks[id] = url;
            saveAppState();
        }

        function saveAppState() {
            localStorage.setItem('euroTripState', JSON.stringify(appState));
        }

         // --- DATOS EXPANDIDOS DE MUSEOS ---
        const extraMuseumsData = [
            { name: "Museos Vaticanos", lat: 41.9064, lng: 12.4547, city: "Vaticano" },
            { name: "Coliseo & Foro", lat: 41.8902, lng: 12.4922, city: "Roma" },
            { name: "Galería Uffizi", lat: 43.7678, lng: 11.2553, city: "Florencia" },
            { name: "Galería de la Academia", lat: 43.7769, lng: 11.2588, city: "Florencia" },
            { name: "Palacio Ducal", lat: 45.4337, lng: 12.3404, city: "Venecia" },
            { name: "Museo del Prado", lat: 40.4138, lng: -3.6921, city: "Madrid" },
            { name: "Museo Reina Sofía", lat: 40.4082, lng: -3.6943, city: "Madrid" },
            { name: "Sagrada Familia", lat: 41.4036, lng: 2.1744, city: "Barcelona" },
            { name: "La Alhambra", lat: 37.1760, lng: -3.5881, city: "Granada" },
            { name: "Real Alcázar", lat: 37.3844, lng: -5.9912, city: "Sevilla" }
        ];

        // --- DATOS DEL VIAJE ACTUALIZADOS (26 ENE START) ---
        const tripData = {
            startDate: new Date("2026-01-26T00:00:00").getTime(),
            route: [
                {
                    id: 'rome', name: 'Roma', 
                    img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTwWyq_eKnfHFkKRUUDfUE5AVSS-kYfHAg1Tg&s',
                    dates: '26-30 Ene (5 noches)',
                    desc: 'Actividades: Coliseo, Vaticano, Panteón, Trastevere.',
                    accommodation: { name: "Rome Soul Close to Navona", address: "55 Via di Santa Maria dell'Anima, Navona", note: "⚠️ Tasa: 150€. Check-in Vikey." },
                    details: {
                        eat: 'Pastasciutta, Pane e Salame, Bonci, Tonnarello, Pompi (Tiramisú), Alcachofas en Barrio Judío.',
                        mustDo: ['Coliseo y Foro (8:30)', 'Museos Vaticanos', 'Atardecer Pincio', 'San Pietro in Vincoli'],
                        tips: ['Panteón: lleva monedas.', 'San Pedro: cash para cúpula.', 'Trastevere al atardecer.'],
                        coords: [41.9028, 12.4964]
                    },
                    dailyItinerary: [
                        { 
                            date: '26/01', title: 'Llegada & Navona', 
                            morning: 'Vuelo y traslado.', 
                            afternoon: 'Piazza Navona, Panteón.', 
                            night: 'Cena: Pastasciutta. Paseo Campo de Fiori.',
                            mapLink: "https://www.google.com/maps/dir/Via+di+Santa+Maria+dell'Anima,+55,+Roma/Piazza+Navona/Pantheon/Pastasciutta,+Via+delle+Grazie,+5,+Roma/@41.900495,12.4578,15z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x132f6050b577a491:0x93302196659f4281!2m2!1d12.4716186!2d41.8993886!1m5!1m1!1s0x132f604f678640a9:0xcad165fa2036ce2c!2m2!1d12.473071!2d41.8991633!1m5!1m1!1s0x132f604f51bd5145:0x546029d150239e92!2m2!1d12.4768729!2d41.8986108!1m5!1m1!1s0x132f60682859158d:0x93361df400305809!2m2!1d12.458285!2d41.9029961!3e2"
                        },
                        { 
                            date: '27/01', title: 'Roma Clásica', 
                            morning: '08:30 Coliseo, Foro. Campo Fiori.', 
                            afternoon: 'Trevi, Plaza España, Pincio.', 
                            night: 'Cena: Pane e Salame.',
                            mapLink: "https://www.google.com/maps/dir/Via+di+Santa+Maria+dell'Anima,+55,+Roma/Colosseo/Campo+de'+Fiori/Fontana+di+Trevi/Piazza+di+Spagna/Terrazza+del+Pincio/Pane+e+Salame,+Via+di+Santa+Maria+in+Via,+Roma/@41.8988,12.4700,14z/data=!3m1!4b1!4m44!4m43!1m5!1m1!1s0x132f6050b577a491:0x93302196659f4281!2m2!1d12.4716186!2d41.8993886!1m5!1m1!1s0x132f61b6532013ad:0x28f1c82e0770f375!2m2!1d12.4922309!2d41.8902102!1m5!1m1!1s0x132f6044c3c332c9:0x8747f48b111664e!2m2!1d12.4721532!2d41.8955598!1m5!1m1!1s0x132f6053278340d9:0xf086653757950411!2m2!1d12.483313!2d41.9009323!1m5!1m1!1s0x132f6053a4794e55:0x272b15525501865a!2m2!1d12.482775!2d41.9056975!1m5!1m1!1s0x132f60548486062d:0xb44497e5967b0707!2m2!1d12.4795368!2d41.9106969!1m5!1m1!1s0x132f6053300d60f9:0x1b444b0c03405c19!2m2!1d12.4811056!2d41.9004868!3e2"
                        },
                        { 
                            date: '28/01', title: 'Vaticano & Trastevere', 
                            morning: 'Museos Vaticanos. Pizza Bonci.', 
                            afternoon: 'San Pedro, Sant\'Angelo.', 
                            night: 'Cena en Trastevere (Tonnarello).',
                            mapLink: "https://www.google.com/maps/dir/Via+di+Santa+Maria+dell'Anima,+55,+Roma/Musei+Vaticani/Pizzarium+Bonci/Basilica+San+Pietro/Castel+Sant'Angelo/Tonnarello,+Via+della+Paglia,+Roma/@41.9015,12.4450,14z/data=!3m1!4b1!4m38!4m37!1m5!1m1!1s0x132f6050b577a491:0x93302196659f4281!2m2!1d12.4716186!2d41.8993886!1m5!1m1!1s0x132f60638069680f:0x395a1219b2e5975!2m2!1d12.453389!2d41.9067425!1m5!1m1!1s0x132f6064e03d9859:0xa6e10265e3c7f999!2m2!1d12.4468208!2d41.9071597!1m5!1m1!1s0x132f6066b4d371e1:0x41da4f3780337d10!2m2!1d12.4539367!2d41.9021667!1m5!1m1!1s0x132f6058e0a87759:0x228723653a233306!2m2!1d12.466276!2d41.9030632!1m5!1m1!1s0x132f603f0b074a1f:0x643195222045c225!2m2!1d12.4704332!2d41.8897587!3e2"
                        },
                        { 
                            date: '29/01', title: 'Basílicas & Antigüedad', 
                            morning: 'S.M. Maggiore, San Giovanni.', 
                            afternoon: 'Catacumbas (Bus/Taxi).', 
                            night: 'Barrio Judío, Pompi.',
                            mapLink: "https://www.google.com/maps/dir/Via+di+Santa+Maria+dell'Anima,+55,+Roma/Basilica+papale+di+Santa+Maria+Maggiore/Arcibasilica+di+San+Giovanni+in+Laterano/Catacombe+di+San+Callisto/Portico+d'Ottavia/Pompi+Tiramis%C3%B9,+Via+della+Croce,+Roma/@41.8800,12.4700,13z/data=!3m1!4b1!4m38!4m37!1m5!1m1!1s0x132f6050b577a491:0x93302196659f4281!2m2!1d12.4716186!2d41.8993886!1m5!1m1!1s0x132f61a33758204b:0x599696c72e297893!2m2!1d12.4983362!2d41.8976193!1m5!1m1!1s0x132f6196f18635c9:0x37851eb3731885f5!2m2!1d12.505673!2d41.8858811!1m5!1m1!1s0x132588c7c9782a2b:0x39a174066060c239!2m2!1d12.5126343!2d41.860824!1m5!1m1!1s0x132f6048d0e5130f:0x1b444b0c03405c19!2m2!1d12.4787053!2d41.8926955!1m5!1m1!1s0x132f60536413a961:0xa5f463283313d332!2m2!1d12.4801121!2d41.9056263!3e2"
                        },
                        { 
                            date: '30/01', title: 'Alternativa & Compras', 
                            morning: 'San Pietro in Vincoli (Moisés).', 
                            afternoon: 'Via del Corso.', 
                            night: 'Última cena.',
                            mapLink: "https://www.google.com/maps/dir/Via+di+Santa+Maria+dell'Anima,+55,+Roma/Basilica+di+San+Pietro+in+Vincoli/Via+del+Corso/Via+di+Santa+Maria+dell'Anima,+55,+Roma/@41.8985,12.4650,15z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x132f6050b577a491:0x93302196659f4281!2m2!1d12.4716186!2d41.8993886!1m5!1m1!1s0x132f61b4566540b9:0x879743c3d5174577!2m2!1d12.4932061!2d41.8938634!1m5!1m1!1s0x132f60548a8002e3:0x1e3f8981442a8b9e!2m2!1d12.4795364!2d41.9031174!1m5!1m1!1s0x132f6050b577a491:0x93302196659f4281!2m2!1d12.4716186!2d41.8993886!3e2"
                        }
                    ],
                    museums: [{name: "Vaticanos", coords: [41.9067, 12.4547]}, {name: "Coliseo", coords: [41.8902, 12.4922]}, {name: "Borghese", coords: [41.9142, 12.4921]}],
                    restaurants: [{name: "Pastasciutta", coords: [41.9056, 12.4571]}, {name: "Tonnarello", coords: [41.8894, 12.4690]}, {name: "Bonci", coords: [41.9073, 12.4463]}]
                },
                {
                    id: 'florence', name: 'Florencia',
                    img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQeLmpjdCytkEtaBoLQ01ltlss0W26PQH05Wg&s',
                    dates: '31 Ene - 02 Feb (3 noches)',
                    desc: 'Actividades: Uffizi, Academia, Duomo, Pisa.',
                    accommodation: { name: "Guya Apartment", address: "37 Via Faenza", note: "Validar billete tren Roma-Florencia." },
                    details: {
                        eat: 'Mercado Central, All\'Antico Vinaio, Oltrarno.',
                        mustDo: ['Piazzale Michelangelo', 'Pisa (02/02)', 'Paseo Oltrarno'],
                        tips: ['Reservar Uffizi/Academia con antelación.', 'Coperto en restaurantes.'],
                        coords: [43.7696, 11.2558]
                    },
                    dailyItinerary: [
                        { 
                            date: '31/01', title: 'Llegada & Vistas', 
                            morning: 'Tren llegada. Mercado Central.', 
                            afternoon: 'Signoria, Ponte Vecchio.', 
                            night: 'Atardecer Piazzale Michelangelo.',
                            mapLink: "https://www.google.com/maps/dir/Via+Faenza,+37,+Firenze/Mercato+Centrale/Piazza+della+Signoria/Ponte+Vecchio/Piazzale+Michelangelo/@43.7700,11.2500,15z/data=!3m1!4b1!4m32!4m31!1m5!1m1!1s0x132a56a67f0f0c0b:0x5e5b6b6b6b6b6b6b!2m2!1d11.2504!2d43.7766!1m5!1m1!1s0x132a5403e0984955:0x5248275152569947!2m2!1d11.2536787!2d43.7765103!1m5!1m1!1s0x132a5400508682a5:0x8c6146c9f0b2f15a!2m2!1d11.2559!2d43.7696!1m5!1m1!1s0x132a54009777e43b:0x3943b174413e1132!2m2!1d11.253198!2d43.767925!1m5!1m1!1s0x132a54050a4b6709:0x879743c3d5174577!2m2!1d11.2649938!2d43.762913!3e2"
                        },
                        { 
                            date: '01/02', title: 'Domingo de Museos', 
                            morning: 'Academia, Uffizi.', 
                            afternoon: 'All\'Antico Vinaio, Duomo.', 
                            night: 'Oltrarno.',
                            mapLink: "https://www.google.com/maps/dir/Via+Faenza,+37,+Firenze/Galleria+dell'Accademia/Galleria+degli+Uffizi/All'Antico+Vinaio/Cupola+del+Brunelleschi/Santo+Spirito,+Firenze/@43.7700,11.2500,15z/data=!3m1!4b1!4m38!4m37!1m5!1m1!1s0x0:0x0!2m2!1d11.2504!2d43.7766!1m5!1m1!1s0x132a541d11639c09:0x8534125b271d4411!2m2!1d11.2584822!2d43.7769288!1m5!1m1!1s0x132a5400f6828b81:0x539660c67e812543!2m2!1d11.2553195!2d43.767786!1m5!1m1!1s0x132a540110c73d7f:0xb90d64488354c46c!2m2!1d11.2575459!2d43.7681123!1m5!1m1!1s0x132a540243171353:0xa95e550e640375a!2m2!1d11.2566!2d43.7732!1m5!1m1!1s0x132a51ff7604f5e1:0x49f25712534575!2m2!1d11.2479!2d43.7674!3e2"
                        },
                        { 
                            date: '02/02', title: 'Excursión a Pisa', 
                            morning: 'Tren a Pisa. Piazza dei Miracoli.', 
                            afternoon: 'Torre, Catedral. Regreso Florencia.', 
                            night: 'Cena despedida.',
                            mapLink: "https://www.google.com/maps/dir/Pisa+Centrale/Piazza+del+Duomo,+Pisa/Pisa+Centrale/@43.7190,10.3900,15z/data=!3m1!4b1!4m20!4m19!1m5!1m1!1s0x12d591a6c429688d:0x2082f0c777421318!2m2!1d10.3986!2d43.7085!1m5!1m1!1s0x12d59190111244e7:0x5c7f99992d9d1b0!2m2!1d10.3966!2d43.7229!1m5!1m1!1s0x12d591a6c429688d:0x2082f0c777421318!2m2!1d10.3986!2d43.7085!3e2"
                        }
                    ],
                    museums: [{name: "Uffizi", coords: [43.7677, 11.2553]}],
                    restaurants: [{name: "All'Antico Vinaio", coords: [43.7683, 11.2568]}]
                },
                {
                    id: 'venice', name: 'Venecia',
                    img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRBdqy1RKq0-8WQfhvT6D5GIV3gePUV8AEB1w&s',
                    dates: '03-04 Feb (2 noches)',
                    desc: 'Actividades: Canales, Palacio Ducal, Murano, Burano.',
                    accommodation: { name: "Hotel Rio Venezia", address: "Castello 4358", note: "Pago en hotel: 602€." },
                    details: {
                        eat: 'Cantina Do Mori (Cicchetti), Risotto en Burano.',
                        mustDo: ['Palacio Ducal', 'Rialto', 'Burano & Murano', 'Fondaco dei Tedeschi'],
                        tips: ['Pase 24h Vaporetto.', 'Reserva mirador Fondaco (gratis).'],
                        coords: [45.4408, 12.3155]
                    },
                    dailyItinerary: [
                        { 
                            date: '03/02', title: 'Llegada & Ducal', 
                            morning: 'Tren llegada. Check-in.', 
                            afternoon: 'Do Mori, Palacio Ducal, Rialto.', 
                            night: 'Cena.',
                            mapLink: "https://www.google.com/maps/dir/Hotel+Rio,+Castello+4358,+Venezia/Cantina+Do+Mori/Palazzo+Ducale/Ponte+di+Rialto/@45.4350,12.3350,15z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x477eb1d67d7a7d43:0x1b1b1b1b1b1b1b1b!2m2!1d12.3423!2d45.4355!1m5!1m1!1s0x477eb1c469f104d5:0x5c3b9b4b0e8b8b8b!2m2!1d12.3338!2d45.4389!1m5!1m1!1s0x477eb1d74338087b:0x5357321683441998!2m2!1d12.3404!2d45.4340!1m5!1m1!1s0x477eb1c462744317:0x6f9b76c1285433a!2m2!1d12.3358!2d45.4380!3e2"
                        },
                        { 
                            date: '04/02', title: 'Islas & San Marco', 
                            morning: 'San Marco, Fondaco.', 
                            afternoon: 'Librería Acqua Alta.', 
                            night: 'Cena.',
                            mapLink: "https://www.google.com/maps/dir/Hotel+Rio,+Castello+4358,+Venezia/Piazza+San+Marco/T+Fondaco+dei+Tedeschi/Libreria+Acqua+Alta/@45.4360,12.3380,16z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x477eb1d67d7a7d43:0x1b1b1b1b1b1b1b1b!2m2!1d12.3423!2d45.4355!1m5!1m1!1s0x477eb1d745d3e527:0x123456789abcdef!2m2!1d12.3396!2d45.4342!1m5!1m1!1s0x477eb1c4701633bd:0x7c7c7c7c7c7c7c7c!2m2!1d12.3370!2d45.4380!1m5!1m1!1s0x477eb1d7a8d0505b:0x8989898989898989!2m2!1d12.3425!2d45.4379!3e2"
                        }
                    ],
                    museums: [{name: "Palacio Ducal", coords: [45.4337, 12.3402]}],
                    restaurants: [{name: "Cantina Do Mori", coords: [45.4385, 12.3355]}]
                },
                {
                    id: 'barcelona', name: 'Barcelona',
                    img: 'https://img2.huffingtonpost.es/files/og_thumbnail/uploads/2024/05/10/la-sagrada-familia-uno-de-los-iconos-de-barcelona.jpeg',
                    dates: '05-08 Feb (4 noches)',
                    desc: 'Actividades: Sagrada Familia, Gótico, Park Güell, Montserrat.',
                    accommodation: { name: "Depto Pau Claris", address: "Pau Claris", note: "Vuelo Venecia -> BCN." },
                    details: {
                        eat: 'Boquería, El Nacional, Sensi Bistro.',
                        mustDo: ['Sagrada Familia', 'Park Güell', 'Montjuïc', 'Montserrat'],
                        tips: ['Reservar entradas con tiempo.', 'Cuidado con carteristas.'],
                        coords: [41.3851, 2.1734]
                    },
                    dailyItinerary: [
                        { 
                            date: '05/02', title: 'Llegada & Gótico', 
                            morning: 'Vuelo llegada.', 
                            afternoon: 'Catedral, Mural Beso, Ramblas, Boquería.', 
                            night: 'Cena.',
                            mapLink: "https://www.google.com/maps/dir/Carrer+de+Pau+Claris,+Barcelona/Catedral+de+Barcelona/El+Món+neix+en+cada+besada/La+Boqueria,+Barcelona/@41.3850,2.1700,15z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x12a4a2f660636733:0x12345678!2m2!1d2.1680!2d41.3910!1m5!1m1!1s0x12a4a2f43d387039:0x93302196659f4281!2m2!1d2.1762!2d41.3839!1m5!1m1!1s0x12a4a2f42a02ae3d:0xabcdef123456!2m2!1d2.1755!2d41.3840!1m5!1m1!1s0x12a4a2f31057790d:0x12345678abcdef!2m2!1d2.1715!2d41.3817!3e2"
                        },
                        { 
                            date: '06/02', title: 'Ruta Gaudí', 
                            morning: 'Sagrada Familia.', 
                            afternoon: 'Park Güell. Paseo Gracia.', 
                            night: 'Cena El Nacional.',
                            mapLink: "https://www.google.com/maps/dir/Carrer+de+Pau+Claris,+Barcelona/La+Sagrada+Familia/Park+Güell/Casa+Batlló/El+Nacional,+Passeig+de+Gràcia,+Barcelona/@41.4000,2.1600,14z/data=!3m1!4b1!4m32!4m31!1m5!1m1!1s0x12a4a2f660636733:0x1!2m2!1d2.1680!2d41.3910!1m5!1m1!1s0x12a4a2dcd0c63023:0x1234!2m2!1d2.1743!2d41.4036!1m5!1m1!1s0x12a4a2ae339592bd:0x5678!2m2!1d2.1527!2d41.4145!1m5!1m1!1s0x12a4a2f6f3a74343:0x9012!2m2!1d2.1616!2d41.3916!1m5!1m1!1s0x12a4a2f68b3f2c5d:0x3456!2m2!1d2.1668!2d41.3895!3e2"
                        },
                        { 
                            date: '07/02', title: 'Montjuïc & Playa', 
                            morning: 'Raval.', 
                            afternoon: 'Barceloneta. Teleférico Montjuïc.', 
                            night: 'Tapas.',
                            mapLink: "https://www.google.com/maps/dir/Carrer+de+Pau+Claris,+Barcelona/Gato+de+Botero/La+Barceloneta/Telefèric+de+Montjuïc/Sensi+Bistro+Tapas/@41.3780,2.1700,14z/data=!3m1!4b1!4m32!4m31!1m5!1m1!1s0x12a4a2f260843231:0x2!2m2!1d2.1695!2d41.3790!1m5!1m1!1s0x12a4a3a160843231:0x3!2m2!1d2.1894!2d41.3805!1m5!1m1!1s0x12a4a27a810c950b:0x4!2m2!1d2.1678!2d41.3686!1m5!1m1!1s0x12a4a25690123456:0x5!2m2!1d2.1780!2d41.3800!3e2"
                        },
                        { 
                            date: '08/02', title: 'Montserrat', 
                            morning: 'Excursión Monasterio.', 
                            afternoon: 'Laberinto Horta.', 
                            night: 'Preparar maletas.',
                            mapLink: "https://www.google.com/maps/dir/Carrer+de+Pau+Claris,+Barcelona/Monasterio+de+Montserrat/Parc+del+Laberint+d'Horta/Carrer+de+Pau+Claris,+Barcelona/@41.5000,1.9000,10z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x12a4a2f660636733:0x1!2m2!1d2.1680!2d41.3910!1m5!1m1!1s0x12a48ed16353f47b:0xabc!2m2!1d1.8375!2d41.5932!1m5!1m1!1s0x12a4bd4c0e643597:0xdef!2m2!1d2.1466!2d41.4399!1m5!1m1!1s0x12a4a2f660636733:0x1!2m2!1d2.1680!2d41.3910!3e0"
                        }
                    ],
                    museums: [{name: "Sagrada Familia", coords: [41.4036, 2.1744]}],
                    restaurants: [{name: "El Nacional", coords: [41.3895, 2.1678]}]
                },
                 {
                    id: 'valencia', name: 'Valencia',
                    img: 'https://media.cnn.com/api/v1/images/stellar/prod/cnne-1637493-gettyimages-520697762.jpg?q=w_1110,c_fill',
                    dates: '09-10 Feb (2 noches)',
                    desc: 'Actividades: Artes y Ciencias, Albufera, Paella.',
                    accommodation: { name: "Valencia Centro Wifi", address: "Valencia", note: "Drive BCN -> Valencia." },
                    details: {
                        eat: 'Paella en Malvarrosa (mediodía).',
                        mustDo: ['Artes y Ciencias', 'Albufera (barca)', 'Lonja Seda'],
                        tips: ['Atracciones horario normal post-Reyes.', 'Mercado cierra a las 15h.'],
                        coords: [39.4699, -0.3763]
                    },
                    dailyItinerary: [
                        { 
                            date: '09/02', title: 'Futuro & Playa', 
                            morning: 'Viaje auto. Centro.', 
                            afternoon: 'Paella Malvarrosa. Artes y Ciencias.', 
                            night: 'Barrio Carmen.',
                            mapLink: "https://www.google.com/maps/dir/Valencia+Centro+Wifi/Playa+de+la+Malvarrosa/Ciudad+de+las+Artes+y+las+Ciencias/Barrio+del+Carmen,+Valencia/@39.4700,-0.3500,13z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0x0:0x0!2m2!1d-0.3763!2d39.4702!1m5!1m1!1s0xd60485c2c792135:0x1!2m2!1d-0.3245!2d39.4770!1m5!1m1!1s0xd6048e420042409:0x2!2m2!1d-0.3507!2d39.4546!1m5!1m1!1s0xd604f4c2c792135:0x3!2m2!1d-0.3780!2d39.4790!3e0"
                        },
                        { 
                            date: '10/02', title: 'Historia & Albufera', 
                            morning: 'Lonja Seda, Mercado.', 
                            afternoon: 'Paseo barca Albufera. Port Saplaya.', 
                            night: 'Cena.',
                            mapLink: "https://www.google.com/maps/dir/Valencia+Centro+Wifi/Mercado+Central,+Valencia/La+Lonja+de+la+Seda/Mirador+Albufera,+Gola+de+Pujol/Port+Saplaya/@39.4000,-0.3500,11z/data=!3m1!4b1!4m32!4m31!1m5!1m1!1s0x0:0x0!2m2!1d-0.3763!2d39.4702!1m5!1m1!1s0xd604f4d2c792135:0x1!2m2!1d-0.3790!2d39.4740!1m5!1m1!1s0xd604f4d2c792135:0x2!2m2!1d-0.3784!2d39.4744!1m5!1m1!1s0xd604ee0c2e3990f:0x3!2m2!1d-0.3340!2d39.3550!1m5!1m1!1s0xd6047c0c2e3990f:0x4!2m2!1d-0.3200!2d39.5150!3e0"
                        }
                    ],
                    museums: [{name: "Artes y Ciencias", coords: [39.4554, -0.3533]}],
                    restaurants: [{name: "La Pepica", coords: [39.4627, -0.3229]}]
                },
                 {
                    id: 'granada', name: 'Granada',
                    img: 'https://www.barcelo.com/guia-turismo/wp-content/uploads/2020/05/que-visitar-en-granada-albaicin.jpg',
                    dates: '11-12 Feb (2 noches)',
                    desc: 'Actividades: Alhambra, Albaicín, Sacromonte.',
                    accommodation: { name: "Hotel Porcel Granada Navas", address: "Granada", note: "Drive Valencia -> Granada." },
                    details: {
                        eat: 'Tapas gratis (Calle Navas), Té en Calderería.',
                        mustDo: ['Alhambra (reservar meses antes)', 'Mirador San Nicolás'],
                        tips: ['Albaicín tiene cuestas, calzado cómodo.', 'DNI obligatorio Alhambra.'],
                        coords: [37.1773, -3.5986]
                    },
                    dailyItinerary: [
                        { 
                            date: '11/02', title: 'Albaicín & Miradores', 
                            morning: 'Viaje auto. Alcaicería.', 
                            afternoon: 'Barrio Albaicín.', 
                            night: 'Atardecer Mirador San Nicolás.',
                            mapLink: "https://www.google.com/maps/dir/Hotel+Porcel+Navas,+Calle+Navas,+Granada/Paseo+de+los+Tristes/Mirador+de+San+Nicolás/Hotel+Porcel+Navas,+Granada/@37.1780,-3.5900,15z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0xd71fce3f4213456:0x1!2m2!1d-3.5985!2d37.1738!1m5!1m1!1s0xd71fce6c5e7b5bd:0x2!2m2!1d-3.5896!2d37.1790!1m5!1m1!1s0xd71fce6e60938b5:0x3!2m2!1d-3.5925!2d37.1812!1m5!1m1!1s0xd71fce3f4213456:0x1!2m2!1d-3.5985!2d37.1738!3e2"
                        },
                        { 
                            date: '12/02', title: 'La Alhambra', 
                            morning: 'Alhambra (Palacios Nazaríes).', 
                            afternoon: 'Sacromonte (cuevas).', 
                            night: 'Tapas Calle Navas.',
                            mapLink: "https://www.google.com/maps/dir/Hotel+Porcel+Navas,+Granada/Alhambra,+Granada/Abadía+del+Sacromonte/Calle+Navas,+Granada/@37.1750,-3.5900,14z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0xd71fce3f4213456:0x1!2m2!1d-3.5985!2d37.1738!1m5!1m1!1s0xd71fce72782782b:0x2!2m2!1d-3.5880!2d37.1760!1m5!1m1!1s0xd71fce98993108b:0x3!2m2!1d-3.5760!2d37.1830!1m5!1m1!1s0xd71fce3f4213456:0x4!2m2!1d-3.5985!2d37.1738!3e2"
                        }
                    ],
                    museums: [{name: "Alhambra", coords: [37.1760, -3.5881]}],
                    restaurants: [{name: "Calle Navas", coords: [37.1739, -3.5991]}]
                },
                 {
                    id: 'sevilla', name: 'Sevilla',
                    img: 'https://images.contentstack.io/v3/assets/blt06f605a34f1194ff/blt5b8acbfd396a737b/67b326bd0607f9cc254c2796/iStock-2028221960-HEADER_MOBILE.jpg?fit=crop&disable=upscale&auto=webp&quality=60&crop=smart',
                    dates: '13-15 Feb (3 noches)',
                    desc: 'Actividades: Alcázar, Giralda, Plaza España, Setas.',
                    accommodation: { name: "Monkey Apartment Cervantes", address: "Sevilla", note: "Drive Granada -> Sevilla." },
                    details: {
                        eat: 'Calle Betis, Helado La Abuela.',
                        mustDo: ['Catedral & Giralda', 'Real Alcázar', 'Plaza España', 'Setas'],
                        tips: ['Enero: Rebajas en Sierpes.', 'Alcázar: comprar anticipada.'],
                        coords: [37.3891, -5.9845]
                    },
                    dailyItinerary: [
                        { 
                            date: '13/02', title: 'Catedral & Río', 
                            morning: 'Viaje auto. Catedral (Giralda).', 
                            afternoon: 'Paseo Guadalquivir.', 
                            night: 'Barrio Santa Cruz.',
                            mapLink: "https://www.google.com/maps/dir/Calle+Cervantes,+Sevilla/Catedral+de+Sevilla/Barrio+de+Santa+Cruz,+Sevilla/@37.3880,-5.9900,15z/data=!3m1!4b1!4m20!4m19!1m5!1m1!1s0xd126c045863c0a5:0x1!2m2!1d-5.9940!2d37.3950!1m5!1m1!1s0xd126c1bd3058869:0x2!2m2!1d-5.9930!2d37.3858!1m5!1m1!1s0xd126c1b82736181:0x3!2m2!1d-5.9890!2d37.3850!3e2"
                        },
                        { 
                            date: '14/02', title: 'Alcázar & Triana', 
                            morning: 'Real Alcázar.', 
                            afternoon: 'Plaza España. Parque M. Luisa.', 
                            night: 'Cena en Triana.',
                            mapLink: "https://www.google.com/maps/dir/Calle+Cervantes,+Sevilla/Real+Alcázar+de+Sevilla/Plaza+de+España/Triana,+Sevilla/@37.3800,-5.9900,14z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0xd126c045863c0a5:0x1!2m2!1d-5.9940!2d37.3950!1m5!1m1!1s0xd126c1c010c22f5:0x2!2m2!1d-5.9915!2d37.3830!1m5!1m1!1s0xd126c21e02161f1:0x3!2m2!1d-5.9869!2d37.3772!1m5!1m1!1s0xd126c09893693f1:0x4!2m2!1d-6.0020!2d37.3830!3e2"
                        },
                        { 
                            date: '15/02', title: 'Vistas & Compras', 
                            morning: 'Casa Pilatos.', 
                            afternoon: 'Compras Sierpes. Atardecer Setas.', 
                            night: 'Cena.',
                            mapLink: "https://www.google.com/maps/dir/Calle+Cervantes,+Sevilla/Casa+de+Pilatos/Setas+de+Sevilla/@37.3920,-5.9900,16z/data=!3m1!4b1!4m20!4m19!1m5!1m1!1s0xd126c045863c0a5:0x1!2m2!1d-5.9940!2d37.3950!1m5!1m1!1s0xd126c10640f1a23:0x2!2m2!1d-5.9870!2d37.3908!1m5!1m1!1s0xd126c05a1099683:0x3!2m2!1d-5.9920!2d37.3930!3e2"
                        }
                    ],
                    museums: [{name: "Alcázar", coords: [37.3844, -5.9912]}],
                    restaurants: [{name: "Triana", coords: [37.3833, -6.0022]}]
                },
                {
                    id: 'toledo', name: 'Toledo',
                    img: 'https://upload.wikimedia.org/wikipedia/commons/6/65/Toledo_%2837737041515%29.jpg',
                    dates: '16-17 Feb (1 noche)',
                    desc: 'Actividades: Mirador, Alcázar, Catedral, Mazapán.',
                    accommodation: { name: "Hotel Abad Toledo", address: "Toledo", note: "Drive Sevilla -> Toledo." },
                    details: {
                        eat: 'Mazapán Santo Tomé, El Albero.',
                        mustDo: ['Mirador del Valle', 'Alcázar', 'Catedral'],
                        tips: ['Invierno frío pero menos turistas.', 'Mirador al atardecer.'],
                        coords: [39.8628, -4.0273]
                    },
                    dailyItinerary: [
                        { 
                            date: '16/02', title: 'Vistas Imperiales', 
                            morning: 'Viaje auto. Mirador del Valle.', 
                            afternoon: 'Alcázar.', 
                            night: 'Cena El Albero.',
                            mapLink: "https://www.google.com/maps/dir/Hotel+Abad+Toledo,+Calle+Real+del+Arrabal,+Toledo/Mirador+del+Valle/Alcázar+de+Toledo/Restaurante+El+Albero,+Toledo/@39.8550,-4.0200,14z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0xd6a0a552554625b:0x1!2m2!1d-4.0245!2d39.8620!1m5!1m1!1s0xd6a0bb6522c0695:0x2!2m2!1d-4.0220!2d39.8480!1m5!1m1!1s0xd6a0ba57c433c23:0x3!2m2!1d-4.0205!2d39.8580!1m5!1m1!1s0xd6a0a56e2101234:0x4!2m2!1d-4.0300!2d39.8600!3e0"
                        },
                        { 
                            date: '17/02', title: 'Catedral & Salida', 
                            morning: 'Catedral, San Juan de los Reyes.', 
                            afternoon: 'Viaje a Madrid (Devolución auto).', 
                            night: 'Check-in Madrid.',
                            mapLink: "https://www.google.com/maps/dir/Hotel+Abad+Toledo/Catedral+Primada+de+Toledo/Monasterio+de+San+Juan+de+los+Reyes,+Toledo/@39.8600,-4.0300,15z/data=!3m1!4b1!4m20!4m19!1m5!1m1!1s0xd6a0a552554625b:0x1!2m2!1d-4.0245!2d39.8620!1m5!1m1!1s0xd6a0ba619726201:0x2!2m2!1d-4.0240!2d39.8570!1m5!1m1!1s0xd6a0bb00806443b:0x3!2m2!1d-4.0320!2d39.8580!3e2"
                        }
                    ],
                    museums: [{name: "Alcázar", coords: [39.8581, -4.0208]}],
                    restaurants: [{name: "El Albero", coords: [39.8645, -4.0245]}]
                },
                {
                    id: 'madrid', name: 'Madrid', 
                    img: 'https://media.traveler.es/photos/6712429132de56225d8bb7ff/4:3/w_1776,h_1332,c_limit/GettyImages-1752719931.jpg',
                    dates: '17-21 Feb (4 noches)',
                    desc: 'Actividades: Prado, Bernabéu, Retiro, Sol.',
                    accommodation: { name: "New Point Opera", address: "Centro", note: "Devolución auto." },
                    details: {
                        eat: 'Bocadillo Calamares (La Campana), San Ginés, San Miguel.',
                        mustDo: ['Prado', 'Retiro', 'Bernabéu', 'Reina Sofía'],
                        tips: ['Rebajas de Enero.', 'Prado horario extendido.'],
                        coords: [40.4168, -3.7038]
                    },
                    dailyItinerary: [
                        { 
                            date: '17/02', title: 'Llegada & Sol', 
                            morning: 'Llegada desde Toledo.', 
                            afternoon: 'Sol, Plaza Mayor.', 
                            night: 'Bocadillo Calamares.',
                            mapLink: "https://www.google.com/maps/dir/New+Point+Opera+Madrid/Puerta+del+Sol/Plaza+Mayor/Mercado+de+San+Miguel/@40.4160,-3.7080,16z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0xd4228787c123456:0x1!2m2!1d-3.7090!2d40.4190!1m5!1m1!1s0xd42287e07a2278b:0x2!2m2!1d-3.7035!2d40.4169!1m5!1m1!1s0xd42287d3a0b4111:0x3!2m2!1d-3.7074!2d40.4154!1m5!1m1!1s0xd42287c48010531:0x4!2m2!1d-3.7090!2d40.4155!3e2"
                        },
                        { 
                            date: '18/02', title: 'Arte & Retiro', 
                            morning: 'Museo del Prado.', 
                            afternoon: 'Mercado San Miguel. Retiro.', 
                            night: 'Barrio Letras.',
                            mapLink: "https://www.google.com/maps/dir/New+Point+Opera+Madrid/Museo+del+Prado/Parque+de+El+Retiro/Barrio+de+las+Letras,+Madrid/@40.4150,-3.6950,15z/data=!3m1!4b1!4m26!4m25!1m5!1m1!1s0xd4228787c123456:0x1!2m2!1d-3.7090!2d40.4190!1m5!1m1!1s0xd42289d67d7a469:0x2!2m2!1d-3.6921!2d40.4138!1m5!1m1!1s0xd42289e657597b3:0x3!2m2!1d-3.6830!2d40.4153!1m5!1m1!1s0xd42288117d2301f:0x4!2m2!1d-3.6980!2d40.4130!3e2"
                        },
                        { 
                            date: '19/02', title: 'Real & Bernabéu', 
                            morning: 'Palacio Real.', 
                            afternoon: 'Templo Debod. Gran Vía. Bernabéu.', 
                            night: 'Cena.',
                            mapLink: "https://www.google.com/maps/dir/New+Point+Opera+Madrid/Palacio+Real+de+Madrid/Templo+de+Debod/Gran+Vía,+Madrid/Estadio+Santiago+Bernabéu/@40.4300,-3.7000,13z/data=!3m1!4b1!4m32!4m31!1m5!1m1!1s0xd4228787c123456:0x1!2m2!1d-3.7090!2d40.4190!1m5!1m1!1s0xd422879d6281729:0x2!2m2!1d-3.7143!2d40.4180!1m5!1m1!1s0xd42286e11603525:0x3!2m2!1d-3.7176!2d40.4240!1m5!1m1!1s0xd42287df17672d5:0x4!2m2!1d-3.7030!2d40.4200!1m5!1m1!1s0xd42291e0d37533f:0x5!2m2!1d-3.6883!2d40.4530!3e2"
                        },
                        { 
                            date: '20/02', title: 'Reina Sofía & Malasaña', 
                            morning: 'Museo Reina Sofía.', 
                            afternoon: 'Atocha. Malasaña.', 
                            night: 'Despedida.',
                            mapLink: "https://www.google.com/maps/dir/New+Point+Opera+Madrid/Museo+Nacional+Centro+de+Arte+Reina+Sofía/Malasaña,+Madrid/@40.4150,-3.7050,14z/data=!3m1!4b1!4m20!4m19!1m5!1m1!1s0xd4228787c123456:0x1!2m2!1d-3.7090!2d40.4190!1m5!1m1!1s0xd422627e7045435:0x2!2m2!1d-3.6946!2d40.4079!1m5!1m1!1s0xd42286377317789:0x3!2m2!1d-3.7050!2d40.4260!3e2"
                        },
                        { 
                            date: '21/02', title: 'Adiós Europa', 
                            morning: 'Churros San Ginés.', 
                            afternoon: 'Traslado Barajas. Vuelo.', 
                            night: 'Fin.',
                            mapLink: "https://www.google.com/maps/dir/New+Point+Opera+Madrid/Chocolatería+San+Ginés/Aeropuerto+Adolfo+Suárez+Madrid-Barajas+(MAD),+T4/@40.4500,-3.6500,12z/data=!3m1!4b1!4m20!4m19!1m5!1m1!1s0xd4228787c123456:0x1!2m2!1d-3.7090!2d40.4190!1m5!1m1!1s0xd42287955c3c04f:0x2!2m2!1d-3.7067!2d40.4166!1m5!1m1!1s0xd4231e712a297e5:0x3!2m2!1d-3.5937!2d40.4915!3e0"
                        }
                    ],
                    museums: [{name: "Prado", coords: [40.4138, -3.6921]}, {name: "Bernabéu", coords: [40.4530, -3.6883]}],
                    restaurants: [{name: "San Ginés", coords: [40.4167, -3.7071]}, {name: "La Campana", coords: [40.4154, -3.7075]}]
                }
            ],
            guide: [
                {
                    title: "Logística y Ahorro",
                    icon: "fa-wallet",
                    color: "text-green-600",
                    bg: "bg-green-50",
                    items: [
                        { t: "Validación en Italia", d: "¡Crítico! Valida el billete físico en máquinas antes de subir al tren. Multas >100€." },
                        { t: "ZTL (Coches)", d: "En Italia no entres al centro histórico con el coche alquilado (Zonas de Tráfico Limitado). Multas automáticas." },
                        { t: "Agua Gratis", d: "En Roma usa los 'nasoni'. En Barcelona, la fuente de Canaletas." },
                        { t: "Requisitos Entrada", d: "Seguro médico (30k€), solvencia (113€/día) y billete de vuelta." }
                    ]
                },
                {
                    title: "Seguridad",
                    icon: "fa-user-shield",
                    color: "text-red-600",
                    bg: "bg-red-50",
                    items: [
                        { t: "El 'Regalo'", d: "Ignora pulseras, rosas o romero (Roma/Madrid). Te cobrarán agresivamente." },
                        { t: "Mancha de Pájaro", d: "Barcelona: si te manchan y 'ayudan' a limpiar, es para robarte." },
                        { t: "Estaciones Tren", d: "Venecia/Roma: No dejes que nadie cargue tus maletas ni 'ayude' en máquinas." }
                    ]
                },
                {
                    title: "Gastronomía",
                    icon: "fa-utensils",
                    color: "text-orange-600",
                    bg: "bg-orange-50",
                    items: [
                        { t: "Horarios España", d: "Comida 14-16h, Cena 21h+. Restaurantes cierran cocina entre medias." },
                        { t: "Regla del Café", d: "Italia: Cappuccino solo desayuno. Después de comer, solo espresso." },
                        { t: "Coperto", d: "En Italia cobran 'coperto' (cubierto) y a veces 'servizio'. Revisa el menú." }
                    ]
                }
            ]
        };

        // --- FUNCIONES CORE ---

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = tripData.startDate - now;
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const text = distance < 0 ? "¡EN VIAJE!" : `Faltan ${days} días`;
            
            const elMobile = document.getElementById("countdown-mobile");
            if(elMobile) elMobile.innerHTML = text;
        }

        function goBack(defaultRoute = 'itinerary') {
            router(defaultRoute);
        }

        function router(view, cityId = null, folderType = null) {
            document.querySelectorAll('.nav-btn, .nav-item').forEach(btn => {
                const isActive = btn.dataset.target === view || (view === 'city' && btn.dataset.target === 'itinerary');
                if (btn.classList.contains('nav-btn')) { 
                    btn.className = `nav-btn flex flex-col items-center justify-center w-full h-full transition group ${isActive ? 'text-warm-500' : 'text-gray-400'}`;
                } else { 
                    btn.className = `nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all font-medium focus:outline-none focus:ring-2 focus:ring-warm-500 ${isActive ? 'bg-winter-100 text-winter-900 font-bold' : 'text-gray-600 hover:bg-gray-50 hover:text-winter-900'}`;
                }
            });

            const app = document.getElementById('app-content');
            app.innerHTML = ''; 
            closePreview(); 
            window.scrollTo(0,0);

            if (window.mapInstance) {
                window.mapInstance.remove();
                window.mapInstance = null;
            }

            switch(view) {
                case 'home': renderHome(app); break;
                case 'itinerary': renderItinerary(app); break;
                case 'docs': renderDocuments(app); break;
                case 'folder': renderFolderView(app, folderType, cityId); break;
                case 'guide': renderGuide(app); break;
                case 'city': 
                    renderCityFull(app, cityId); 
                    // Inicializar mapa específico de ciudad después de renderizar
                    setTimeout(() => initCityMap(cityId), 300);
                    break;
                case 'map': renderMap(app); break;
                case 'currency': 
                    renderCurrency(app); 
                    fetchLiveRates(); 
                    break;
                default: renderHome(app);
            }
        }

        // --- RENDERIZADORES ---

        function renderHome(container) {
            const rome = tripData.route[0];
            const madrid = tripData.route[tripData.route.length - 1];

            container.innerHTML = `
                <div class="p-6 md:p-0 fade-in max-w-5xl mx-auto">
                    <div class="mb-8 md:mt-6">
                        <h2 class="font-serif text-3xl md:text-4xl text-winter-900 mb-2">Hola, <span class="text-warm-500">Viajero</span></h2>
                        <p class="text-gray-600 text-sm md:text-base">Tu itinerario de 2026 está listo. Salida el 26/01.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <div class="grid grid-cols-2 gap-4">
                                <div onclick="router('itinerary')" role="button" class="bg-white p-4 rounded-2xl shadow-card border border-gray-100 cursor-pointer hover:border-warm-500 transition-colors">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-plane-arrival"></i></div>
                                        <div>
                                            <h3 class="font-bold text-winter-900 text-sm">Llegada</h3>
                                            <p class="text-xs text-gray-500">Roma, 26 Ene</p>
                                        </div>
                                    </div>
                                </div>
                                <div onclick="router('itinerary')" role="button" class="bg-white p-4 rounded-2xl shadow-card border border-gray-100 cursor-pointer hover:border-red-500 transition-colors">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-10 h-10 bg-red-50 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-plane-departure"></i></div>
                                        <div>
                                            <h3 class="font-bold text-winter-900 text-sm">Regreso</h3>
                                            <p class="text-xs text-gray-500">Madrid, 21 Feb</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-bold text-lg mb-4 text-gray-800">Tu Ruta Principal</h3>
                                ${renderSplitCard(rome, madrid)}
                            </div>
                        </div>

                        <div class="lg:col-span-1">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Próximas Paradas</h3>
                            <div class="space-y-0 relative pl-4 border-l-2 border-gray-200 ml-2">
                                ${tripData.route.slice(0, 5).map(city => `
                                    <div class="mb-6 pl-4 relative cursor-pointer group" onclick="openPreview('${city.id}')" role="button">
                                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-white border-2 border-warm-500 rounded-full group-hover:scale-125 transition-transform"></div>
                                        <span class="text-[10px] font-bold text-warm-500 uppercase tracking-wider block mb-1">${city.dates.split('(')[0]}</span>
                                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 group-hover:shadow-md transition-all">
                                            <h4 class="font-bold text-gray-800 text-sm">${city.name}</h4>
                                        </div>
                                    </div>
                                `).join('')}
                                <button onclick="router('itinerary')" class="text-xs text-gray-500 font-medium hover:text-warm-500 ml-4">Ver itinerario completo →</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- GESTOR DOCUMENTAL (FOLDERS FIRST) ---
        
        const docCategories = [
            { id: 'vuelos', name: 'Vuelos', icon: 'fa-plane-departure', color: 'bg-blue-100 text-blue-600' },
            { id: 'reservas', name: 'Reservas', icon: 'fa-hotel', color: 'bg-purple-100 text-purple-600' },
            { id: 'entradas', name: 'Entradas', icon: 'fa-ticket-alt', color: 'bg-pink-100 text-pink-600' },
            { id: 'transporte', name: 'Transporte', icon: 'fa-train', color: 'bg-green-100 text-green-600' },
            { id: 'seguro', name: 'Seguro', icon: 'fa-file-medical', color: 'bg-red-100 text-red-600' },
            { id: 'identificaciones', name: 'Identificaciones', icon: 'fa-id-card', color: 'bg-orange-100 text-orange-600' }
        ];

        function renderDocuments(container) {
            // Generar Grid de Carpetas Oficiales
            const foldersHTML = docCategories.map(cat => `
                <div onclick="router('folder', null, '${cat.name}')" class="folder-card bg-white p-5 rounded-2xl shadow-card border border-gray-100 cursor-pointer transition-all hover:shadow-lg flex flex-col items-center justify-center text-center gap-3 h-32 md:h-40 relative group">
                     ${appState.cloudLinks[cat.name] ? '<div class="absolute top-2 right-2 text-green-500"><i class="fas fa-link"></i></div>' : ''}
                    <div class="w-12 h-12 rounded-full ${cat.color} flex items-center justify-center folder-icon transition-transform duration-300">
                        <i class="fas ${cat.icon} text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">${cat.name}</span>
                </div>
            `).join('');

            // Generar Galería de Ciudades (Google Drive Simulation)
            const citiesHTML = tripData.route.map(city => `
                <div onclick="router('folder', '${city.id}', 'city_memory')" class="relative rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all cursor-pointer h-24 md:h-32 group">
                    <img src="${city.img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                        <h4 class="text-white font-bold text-sm shadow-black drop-shadow-md text-center px-2">${city.name}</h4>
                    </div>
                    <div class="absolute top-2 right-2 bg-white/90 w-6 h-6 rounded-full flex items-center justify-center text-[10px] ${appState.cloudLinks['city_' + city.id] ? 'text-green-600' : 'text-gray-800'} shadow-sm">
                        <i class="fab fa-google-drive"></i>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto">
                    <!-- Drop Zone / Upload Input Hidden -->
                    <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)" accept=".pdf,image/*">
                    
                    <div class="mb-8 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl font-serif font-bold text-winter-900 mb-2">Documentación</h2>
                            <p class="text-gray-600 text-sm">Tus carpetas seguras.</p>
                        </div>
                        <button onclick="openDriveConfig()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-200 transition-colors flex items-center gap-2">
                            <i class="fas fa-cog"></i> Vincular Drive
                        </button>
                    </div>

                    <!-- Grid Carpetas Documentos -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-10">
                        ${foldersHTML}
                    </div>

                    <div class="mb-6 border-t border-gray-200 pt-8">
                         <div class="flex items-center gap-3 mb-6">
                             <div class="p-2 bg-yellow-100 rounded-lg text-yellow-600"><i class="fas fa-images"></i></div>
                             <div>
                                <h3 class="text-xl font-bold text-gray-800">Memorias de Viaje</h3>
                                <p class="text-xs text-gray-500">Sube fotos y videos a la nube de cada ciudad.</p>
                             </div>
                         </div>
                        
                        <!-- Grid Ciudades -->
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${citiesHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CONFIG DRIVE ---
        function openDriveConfig() {
            const list = document.getElementById('drive-config-list');
            list.innerHTML = '';
            
            // Categorias
            list.innerHTML += `<h4 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wider">Categorías Principales</h4>`;
            docCategories.forEach(cat => {
                const val = appState.cloudLinks[cat.name] || '';
                list.innerHTML += `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">${cat.name}</label>
                        <div class="flex gap-2">
                             <div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center shrink-0"><i class="fas ${cat.icon} text-gray-400"></i></div>
                             <input type="url" placeholder="Pegar enlace de Google Drive/Dropbox..." 
                                    value="${val}" 
                                    onchange="saveCloudLink('${cat.name}', this.value)"
                                    class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-warm-500 outline-none">
                        </div>
                    </div>
                `;
            });

            // Ciudades
            list.innerHTML += `<h4 class="font-bold text-gray-800 mb-3 mt-6 text-sm uppercase tracking-wider">Carpetas por Ciudad</h4>`;
            tripData.route.forEach(city => {
                const key = 'city_' + city.id;
                const val = appState.cloudLinks[key] || '';
                list.innerHTML += `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">${city.name}</label>
                        <div class="flex gap-2">
                             <img src="${city.img}" class="w-8 h-8 rounded object-cover shrink-0 grayscale opacity-50">
                             <input type="url" placeholder="Enlace a carpeta de ${city.name}..." 
                                    value="${val}" 
                                    onchange="saveCloudLink('${key}', this.value)"
                                    class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-warm-500 outline-none">
                        </div>
                    </div>
                `;
            });

            document.getElementById('drive-modal').classList.remove('hidden');
        }

        // --- VISTA DE CARPETA INDIVIDUAL ---
        function renderFolderView(container, folderType, cityId) {
            let title = folderType;
            let context = folderType;
            let isCityMemory = false;

            if (folderType === 'city_memory' && cityId) {
                const city = tripData.route.find(c => c.id === cityId);
                title = city ? city.name : 'Ciudad';
                context = `city_${cityId}`; 
                isCityMemory = true;
            }

            // Filtrar documentos por este contexto
            const filteredDocs = appState.documents.filter(doc => doc.category === context);
            const externalLink = appState.cloudLinks[context];

            const docsListHTML = filteredDocs.length === 0 
                ? `<div class="col-span-full py-10 text-center border-2 border-dashed border-gray-200 rounded-2xl bg-gray-50">
                     <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                        <i class="fas fa-cloud-upload-alt text-2xl"></i>
                     </div>
                     <p class="text-gray-500 font-medium mb-1">Carpeta local vacía</p>
                     <p class="text-xs text-gray-400 mb-4">Usa el botón "Subir" para guardar copia offline.</p>
                   </div>`
                : filteredDocs.map((doc, index) => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative group hover:shadow-md transition-all">
                        <button onclick="deleteDocumentByName('${doc.name}', '${context}')" class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full text-gray-300 hover:text-red-500 shadow-sm flex items-center justify-center z-10"><i class="fas fa-times text-xs"></i></button>
                        
                        <!-- Preview Icon/Image -->
                        <div class="h-32 bg-gray-50 rounded-lg mb-3 overflow-hidden flex items-center justify-center cursor-pointer" onclick="viewDocument('${doc.data}', '${doc.type}')">
                            ${doc.type.startsWith('image/') 
                                ? `<img src="${doc.data}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">` 
                                : `<i class="fas fa-file-pdf text-4xl text-red-500"></i>`
                            }
                        </div>
                        
                        <h4 class="font-bold text-gray-800 text-xs truncate mb-1" title="${doc.name}">${doc.name}</h4>
                        <p class="text-[10px] text-gray-400">${new Date(doc.date).toLocaleDateString()}</p>
                    </div>
                `).join('');

            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto h-full flex flex-col">
                    <!-- Header Carpeta -->
                    <div class="flex items-center gap-4 mb-8">
                        <button onclick="router('docs')" class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-50 shadow-sm transition-colors">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block">Carpeta</span>
                            <h2 class="text-2xl font-serif font-bold text-winter-900 flex items-center gap-2">
                                ${isCityMemory ? '<i class="fab fa-google-drive text-green-600"></i>' : '<i class="fas fa-folder-open text-warm-500"></i>'} 
                                ${title}
                            </h2>
                        </div>
                        <div class="ml-auto flex gap-2">
                             ${externalLink ? `<a href="${externalLink}" target="_blank" class="bg-green-600 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-lg hover:bg-green-700 transition-colors flex items-center gap-2"><i class="fas fa-external-link-alt"></i> <span class="hidden md:inline">Abrir Drive Real</span></a>` : ''}
                            <button onclick="triggerUpload('${context}')" class="bg-winter-900 text-white px-5 py-2.5 rounded-xl font-bold text-xs shadow-lg hover:bg-warm-500 transition-colors flex items-center gap-2">
                                <i class="fas fa-plus"></i> <span class="hidden md:inline">Subir Local</span>
                            </button>
                        </div>
                    </div>
                    
                    ${!externalLink ? `<div class="mb-4 bg-yellow-50 border border-yellow-100 p-3 rounded-xl flex items-center gap-3 text-xs text-yellow-800"><i class="fas fa-info-circle"></i> <span>Esta carpeta no tiene enlace a Drive configurado. <button onclick="openDriveConfig()" class="underline font-bold">Configurar aquí</button></span></div>` : ''}

                    <!-- Grid Archivos Locales -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        ${docsListHTML}
                    </div>

                    <!-- Hidden Input reused -->
                    <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)" accept=".pdf,image/*,video/*">
                </div>
            `;
        }

        function triggerUpload(context) {
            currentUploadContext = context;
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            if (!currentUploadContext) {
                alert("Error: No se ha seleccionado carpeta.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const result = e.target.result;
                
                // Limite seguridad localStorage (aprox)
                if(result.length > 4000000) {
                    alert("El archivo es muy grande para esta demo offline (Máx 4MB).");
                    input.value = ''; // Reset
                    return;
                }

                const newDoc = {
                    name: file.name,
                    category: currentUploadContext, // Usamos el contexto actual (ej: 'Vuelos' o 'city_rome')
                    date: new Date().toISOString(),
                    type: file.type,
                    data: result 
                };

                appState.documents.push(newDoc);
                saveAppState();
                
                // Recargar la vista actual para mostrar el nuevo archivo
                // Determinamos si es ciudad o categoria normal
                if (currentUploadContext.startsWith('city_')) {
                    const cityId = currentUploadContext.replace('city_', '');
                    renderFolderView(document.getElementById('app-content'), 'city_memory', cityId);
                } else {
                    renderFolderView(document.getElementById('app-content'), currentUploadContext);
                }
                
                input.value = ''; // Reset input
            };
            reader.readAsDataURL(file);
        }

        function deleteDocumentByName(name, context) {
            if(confirm('¿Borrar archivo permanentemente?')) {
                // Filtramos para quitar el documento específico en el contexto específico
                appState.documents = appState.documents.filter(doc => !(doc.name === name && doc.category === context));
                saveAppState();
                
                // Recargar vista
                if (context.startsWith('city_')) {
                    const cityId = context.replace('city_', '');
                    renderFolderView(document.getElementById('app-content'), 'city_memory', cityId);
                } else {
                    renderFolderView(document.getElementById('app-content'), context);
                }
            }
        }

        function deleteDocument(index) {
             // Legacy support if needed, mostly replaced by deleteDocumentByName inside folders
             if(confirm('¿Borrar documento?')) {
                appState.documents.splice(index, 1);
                saveAppState();
                router('docs');
            }
        }

        function viewDocument(data, type) {
            const win = window.open();
            if (type.startsWith('image/')) {
                win.document.write(`<img src="${data}" style="max-width:100%; margin: 0 auto; display: block;"> <body style="background: #111; margin:0; display:flex; align-items:center; justify-content:center; height:100vh;">`);
            } else if (type === 'application/pdf') {
                win.document.write(`<embed width="100%" height="100%" src="${data}" type="application/pdf">`);
            } else {
                win.document.write('Vista previa no disponible. <a href="' + data + '" download="archivo">Descargar</a>');
            }
        }

        function renderCurrency(container) {
            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-xl mx-auto">
                    <div class="mb-8 text-center md:text-left">
                         <div class="flex items-center justify-between">
                            <h2 class="text-3xl font-serif font-bold text-winter-900 mb-2">Calculadora</h2>
                            <button onclick="document.getElementById('rates-config').classList.toggle('hidden')" class="text-warm-500 text-sm font-bold bg-warm-50 px-3 py-1 rounded-full hover:bg-warm-100 transition-colors"><i class="fas fa-cog"></i> Configurar</button>
                        </div>
                        <p class="text-gray-600 text-sm">Cambio Dólar Blue.</p>
                    </div>

                    <div id="cotizaciones" class="grid grid-cols-2 gap-4 mb-6">
                        <div id="dolar-blue-container" class="bg-green-50 p-3 rounded-xl border border-green-100 flex flex-col items-center justify-center text-center shadow-sm">
                            <span class="text-[10px] font-bold text-green-600 uppercase tracking-wider mb-1">Dólar Blue</span>
                            <div class="flex items-center gap-1 text-green-800">
                                <span id="dh-dolar" class="text-2xl font-bold">Cargando...</span>
                            </div>
                        </div>
                        <div id="euro-blue-container" class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex flex-col items-center justify-center text-center shadow-sm">
                            <span class="text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-1">Euro Blue</span>
                            <div class="flex items-center gap-1 text-blue-800">
                                <span id="dh-euro" class="text-2xl font-bold">Cargando...</span>
                            </div>
                        </div>
                    </div>

                    <div id="rates-config" class="hidden mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200 animate-slide-up">
                        <h4 class="font-bold text-gray-700 mb-3 text-xs uppercase">Configurar Manualmente (1 Unidad = ARS)</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] block mb-1">EURO</label><input type="number" id="rate-eur" value="${appState.exchangeRates.eurToArs}" onchange="updateRates()" class="w-full p-2 border rounded"></div>
                            <div><label class="text-[10px] block mb-1">DÓLAR</label><input type="number" id="rate-usd" value="${appState.exchangeRates.usdToArs}" onchange="updateRates()" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-winter-900 relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Peso Argentino (ARS)</label>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl text-winter-900 font-serif">$</span>
                                <input type="number" id="input-ars" placeholder="0" oninput="calculateCurrency('ars')" class="w-full text-3xl font-bold text-gray-800 outline-none">
                                <img src="https://flagcdn.com/w40/ar.png" class="w-8 h-auto opacity-80">
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-blue-500 relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Euro (EUR)</label>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl text-blue-600 font-serif">€</span>
                                <input type="number" id="input-eur" placeholder="0" oninput="calculateCurrency('eur')" class="w-full text-3xl font-bold text-gray-800 outline-none">
                                <img src="https://flagcdn.com/w40/eu.png" class="w-8 h-auto opacity-80">
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-green-500 relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Dólar (USD)</label>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl text-green-600 font-serif">$</span>
                                <input type="number" id="input-usd" placeholder="0" oninput="calculateCurrency('usd')" class="w-full text-3xl font-bold text-gray-800 outline-none">
                                <img src="https://flagcdn.com/w40/us.png" class="w-8 h-auto opacity-80">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchLiveRates() {
             const elDolar = document.getElementById("dh-dolar");
             const elEuro = document.getElementById("dh-euro");
             if(!elDolar || !elEuro) return; 

             elDolar.innerText = "Cargando...";
             elEuro.innerText = "Cargando...";

             try {
                // Usando DolarAPI.com que es más estable y devuelve JSON directo
                const [dolarRes, euroRes] = await Promise.all([
                    fetch('https://dolarapi.com/v1/dolares/blue'),
                    fetch('https://dolarapi.com/v1/euros/blue')
                ]);

                if (!dolarRes.ok || !euroRes.ok) throw new Error('API Error');

                const dolarData = await dolarRes.json();
                const euroData = await euroRes.json();

                const valUsd = parseFloat(dolarData.venta) || 1250;
                const valEur = parseFloat(euroData.venta) || 1350;

                elDolar.innerText = `$ ${valUsd}`;
                elEuro.innerText = `$ ${valEur}`;

                const inputUsd = document.getElementById('rate-usd');
                if(inputUsd) inputUsd.value = valUsd;
                const inputEur = document.getElementById('rate-eur');
                if(inputEur) inputEur.value = valEur;

                appState.exchangeRates.usdToArs = valUsd;
                appState.exchangeRates.eurToArs = valEur;
                saveExchangeRates(appState.exchangeRates);
            } catch (error) {
                console.error("Error fetching rates:", error);
                // Fallback a valores guardados o por defecto si falla
                elDolar.innerText = `$ ${appState.exchangeRates.usdToArs}`;
                elEuro.innerText = `$ ${appState.exchangeRates.eurToArs}`;
            }
        }

        function updateRates() {
            const newEur = parseFloat(document.getElementById('rate-eur').value) || 1350;
            const newUsd = parseFloat(document.getElementById('rate-usd').value) || 1250;
            saveExchangeRates({ eurToArs: newEur, usdToArs: newUsd, eurToUsd: newEur / newUsd });
            if(document.getElementById('input-ars').value) calculateCurrency('ars');
        }

        function calculateCurrency(source) {
            const arsInput = document.getElementById('input-ars');
            const eurInput = document.getElementById('input-eur');
            const usdInput = document.getElementById('input-usd');
            const rates = appState.exchangeRates;
            let val = 0;

            if (source === 'ars') {
                val = parseFloat(arsInput.value);
                if (isNaN(val)) { eurInput.value = ''; usdInput.value = ''; return; }
                eurInput.value = (val / rates.eurToArs).toFixed(2);
                usdInput.value = (val / rates.usdToArs).toFixed(2);
            } else if (source === 'eur') {
                val = parseFloat(eurInput.value);
                if (isNaN(val)) { arsInput.value = ''; usdInput.value = ''; return; }
                arsInput.value = (val * rates.eurToArs).toFixed(0);
                usdInput.value = (val * (rates.eurToArs / rates.usdToArs)).toFixed(2);
            } else if (source === 'usd') {
                val = parseFloat(usdInput.value);
                if (isNaN(val)) { arsInput.value = ''; eurInput.value = ''; return; }
                arsInput.value = (val * rates.usdToArs).toFixed(0);
                eurInput.value = (val * (rates.usdToArs / rates.eurToArs)).toFixed(2);
            }
        }

        function renderGuide(container) {
            const categories = tripData.guide.map((cat) => `
                <div class="bg-white rounded-2xl shadow-card overflow-hidden border border-gray-100 mb-6 break-inside-avoid">
                    <div class="p-4 ${cat.bg} border-b border-gray-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm ${cat.color}">
                            <i class="fas ${cat.icon}"></i>
                        </div>
                        <h3 class="font-bold text-winter-900 text-lg">${cat.title}</h3>
                    </div>
                    <div class="p-5 divide-y divide-gray-50">
                        ${cat.items.map(item => `
                            <div class="py-3 first:pt-0 last:pb-0">
                                <h4 class="text-sm font-bold text-winter-900 mb-1 flex items-center gap-2"><i class="fas fa-check-circle text-xs text-gray-300"></i> ${item.t}</h4>
                                <p class="text-xs text-gray-700 leading-relaxed pl-5">${item.d}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto">
                    <div class="mb-8 text-center md:text-left">
                        <h2 class="text-3xl font-serif font-bold text-winter-900 mb-2">Guía Práctica</h2>
                        <p class="text-gray-600 text-sm max-w-2xl">Consejos esenciales.</p>
                    </div>
                    <div class="columns-1 md:columns-2 gap-6 space-y-6">${categories}</div>
                </div>
            `;
        }

        function renderItinerary(container) {
            const gridHTML = tripData.route.map(city => renderCityCard(city)).join('');
            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto">
                    <div class="flex items-end justify-between mb-8 border-b border-gray-200 pb-4">
                        <div>
                            <span class="text-xs font-bold text-warm-500 uppercase tracking-widest">Viaje Completo</span>
                            <h2 class="text-4xl font-serif font-bold text-winter-900 mt-1">Itinerario 2026</h2>
                        </div>
                        <span class="bg-winter-100 text-winter-800 px-3 py-1 rounded-full text-xs font-bold mb-1">${tripData.route.length} Paradas</span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${gridHTML}</div>
                </div>
            `;
        }

        // --- FUNCIONES NUEVAS: MAPA DE CIUDAD DETALLADO ---

        function initCityMap(cityId) {
            const city = tripData.route.find(c => c.id === cityId);
            if(!city || !city.details.coords) return;

            const mapId = `city-map-${cityId}`;
            const mapContainer = document.getElementById(mapId);
            if(!mapContainer) return;

            if(window.cityMapInstance) {
                window.cityMapInstance.remove();
            }

            const map = L.map(mapId, { zoomControl: false }).setView(city.details.coords, 14);
            window.cityMapInstance = map;

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
                attribution: '© OpenStreetMap, © CartoDB' 
            }).addTo(map);

            const museumIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin" style="background: #9333ea;"></div><i class="fas fa-landmark text-purple-700 text-[10px]" style="margin-top: -8px; margin-left: -11px; z-index: 10;"></i>`, iconSize: [30, 42], iconAnchor: [15, 42] });
            const foodIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin bg-orange-500"></div><i class="fas fa-utensils text-orange-600 text-[10px]" style="margin-top: -8px; margin-left: -11px; z-index: 10;"></i>`, iconSize: [30, 42], iconAnchor: [15, 42] });

            if(city.museums) {
                city.museums.forEach(m => L.marker(m.coords, {icon: museumIcon}).bindPopup(`<b>${m.name}</b>`).addTo(map));
            }
            if(city.restaurants) {
                city.restaurants.forEach(r => L.marker(r.coords, {icon: foodIcon}).bindPopup(`<b>${r.name}</b>`).addTo(map));
            }
        }

        function renderCityFull(container, cityId) {
            const city = tripData.route.find(c => c.id === cityId);
            if(!city) return renderHome(container);

            const timelineHTML = city.dailyItinerary ? city.dailyItinerary.map((day, index) => `
                <div class="timeline-item relative pl-8 pb-8">
                    <div class="timeline-line"></div>
                    <div class="absolute left-0 top-0 w-8 h-8 rounded-full bg-warm-100 border-2 border-warm-500 flex items-center justify-center text-xs font-bold text-warm-600 shadow-sm z-10">${day.date.split('/')[0]}</div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 ml-2">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-winter-900 text-lg">${day.title}</h4>
                            ${day.mapLink ? `<a href="${day.mapLink}" target="_blank" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 border border-blue-100 transition-colors"><i class="fas fa-map-marked-alt"></i> Ver Ruta</a>` : ''}
                        </div>
                        <div class="space-y-3">
                            <div class="flex gap-3">
                                <div class="w-6 shrink-0 text-center"><i class="fas fa-sun text-yellow-500 mt-1"></i></div>
                                <p class="text-sm text-gray-600"><span class="font-semibold text-gray-800">Mañana:</span> ${day.morning}</p>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-6 shrink-0 text-center"><i class="fas fa-utensils text-orange-500 mt-1"></i></div>
                                <p class="text-sm text-gray-600"><span class="font-semibold text-gray-800">Tarde:</span> ${day.afternoon}</p>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-6 shrink-0 text-center"><i class="fas fa-moon text-indigo-500 mt-1"></i></div>
                                <p class="text-sm text-gray-600"><span class="font-semibold text-gray-800">Noche:</span> ${day.night}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500">Itinerario en construcción.</p>';

            const mustDoHTML = city.details.mustDo.map((item, i) => {
                const uniqueId = `${cityId}-mustdo-${i}`;
                const isChecked = appState.checkedItems[uniqueId] ? 'checked' : '';
                return `
                <label class="custom-checkbox flex items-start gap-3 p-3 bg-white border border-gray-100 rounded-xl cursor-pointer shadow-sm hover:border-warm-200 transition-all select-none">
                    <input type="checkbox" class="hidden" ${isChecked} onchange="saveCheckState('${uniqueId}', this.checked)">
                    <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center bg-white transition-colors shrink-0 mt-0.5"><i class="fas fa-check text-white text-[10px] hidden"></i></div>
                    <span class="text-sm text-gray-700 font-medium">${item}</span>
                </label>
            `}).join('');

             const tipsHTML = city.details.tips.map(tip => `<li class="flex gap-3 text-sm text-gray-700 bg-red-50 p-3 rounded-lg border border-red-100"><i class="fas fa-exclamation-circle text-red-500 mt-0.5 shrink-0"></i><span>${tip}</span></li>`).join('');

            container.innerHTML = `
                <div class="pb-20 fade-in bg-white min-h-full">
                    <!-- HERO -->
                    <div class="relative h-[30vh] md:h-[35vh] w-full overflow-hidden">
                        <img src="${city.img}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-winter-900/90 via-transparent to-transparent"></div>
                        <button onclick="goBack('itinerary')" class="absolute top-4 left-4 z-20 bg-white/20 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-white hover:text-winter-900 transition-all border border-white/30"><i class="fas fa-arrow-left"></i></button>
                        <div class="absolute bottom-0 left-0 w-full p-6 text-white">
                            <div class="max-w-6xl mx-auto">
                                <span class="bg-warm-500 text-white px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider mb-2 inline-block">${city.dates}</span>
                                <h1 class="text-3xl md:text-5xl font-serif font-bold mb-2">${city.name}</h1>
                                <p class="opacity-90 text-sm md:text-base max-w-xl">${city.desc}</p>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-6xl mx-auto px-4 py-8 relative z-10">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <!-- COLUMNA PRINCIPAL (ITINERARIO) -->
                            <div class="lg:col-span-2 space-y-8">
                                <div>
                                    <h3 class="font-bold text-winter-900 flex items-center gap-2 text-lg mb-6 border-b border-gray-100 pb-2">
                                        <i class="fas fa-calendar-alt text-warm-500"></i> Itinerario Día a Día
                                    </h3>
                                    <div class="relative pl-2">
                                        ${timelineHTML}
                                    </div>
                                </div>

                                <!-- MAPA INTERACTIVO -->
                                <div>
                                    <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                                        <h3 class="font-bold text-winter-900 flex items-center gap-2 text-lg">
                                            <i class="fas fa-map text-blue-600"></i> Mapa de la Zona
                                        </h3>
                                        <a href="https://www.google.com/maps/search/?api=1&query=${city.details.coords[0]},${city.details.coords[1]}" target="_blank" class="text-xs font-bold text-blue-600 hover:underline bg-blue-50 px-3 py-1 rounded-full"><i class="fas fa-external-link-alt"></i> Google Maps</a>
                                    </div>
                                    <div id="city-map-${cityId}" class="w-full h-64 rounded-xl shadow-inner border border-gray-200 z-0 relative"></div>
                                </div>

                                <!-- GASTRONOMIA -->
                                <div>
                                    <h3 class="font-bold text-winter-900 flex items-center gap-2 text-lg mb-4 border-b border-gray-100 pb-2">
                                        <i class="fas fa-pizza-slice text-red-500"></i> Gastronomía Local
                                    </h3>
                                    <div class="bg-orange-50 rounded-xl p-5 border border-orange-100 text-orange-900 text-sm italic relative">
                                        <i class="fas fa-quote-left absolute top-4 left-4 text-orange-200 text-4xl -z-0"></i>
                                        <p class="relative z-10 leading-relaxed">${city.details.eat}</p>
                                    </div>
                                </div>

                                <button onclick="triggerMagicPrompt('Dime 3 datos curiosos históricos sobre ${city.name} que pocos turistas sepan', 'Historiador')" class="w-full py-4 bg-gradient-to-r from-winter-800 to-winter-900 text-white rounded-xl shadow-lg font-bold text-sm flex items-center justify-center gap-2 hover:scale-[1.01] transition-transform">
                                    <i class="fas fa-magic text-warm-500"></i> Descubrir Secretos Ocultos con IA
                                </button>
                            </div>

                            <!-- COLUMNA LATERAL (DERECHA) -->
                            <div class="md:col-span-1 space-y-6">
                                <!-- Alojamiento -->
                                ${city.accommodation ? `
                                <div class="bg-winter-900 rounded-xl shadow-lg p-5 text-white relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-warm-500 opacity-10 rounded-full -mr-10 -mt-10"></div>
                                    <h3 class="font-bold text-sm uppercase tracking-wide text-gray-400 mb-3">Tu Alojamiento</h3>
                                    <p class="font-serif text-lg mb-1 leading-tight">${city.accommodation.name}</p>
                                    <p class="text-xs text-gray-400 mb-3 truncate"><i class="fas fa-map-marker-alt mr-1"></i> ${city.accommodation.address}</p>
                                    ${city.accommodation.note ? `<div class="bg-white/10 p-2 rounded-lg text-[10px] leading-tight border border-white/20"><i class="fas fa-info-circle text-warm-500 mr-1"></i> ${city.accommodation.note}</div>` : ''}
                                </div>
                                ` : ''}

                                <!-- Checklist -->
                                <div class="bg-white rounded-xl shadow-card p-5 border border-gray-100">
                                    <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wide border-b border-gray-50 pb-2">Checklist Imprescindible</h3>
                                    <div class="space-y-2 max-h-96 overflow-y-auto pr-1 custom-scrollbar">${mustDoHTML}</div>
                                </div>

                                <!-- Tips -->
                                <div class="bg-white rounded-xl shadow-card p-5 border border-gray-100">
                                    <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wide border-b border-gray-50 pb-2">Tips Locales</h3>
                                    <ul class="space-y-2">${tipsHTML}</ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMap(container) {
            container.innerHTML = `
                <div class="h-full w-full relative fade-in">
                    <div id="map" class="h-full w-full bg-gray-200 z-10"></div>
                    <button id="search-here-btn" onclick="fetchMapData()" class="search-here-btn absolute top-6 left-1/2 transform -translate-x-1/2 bg-white text-winter-900 px-5 py-2.5 rounded-full shadow-lg z-[1000] text-xs font-bold flex items-center gap-2 cursor-pointer hover:bg-gray-50 hover:shadow-xl"><i class="fas fa-search text-warm-500"></i> <span>Buscar en esta zona</span></button>
                    <div class="absolute bottom-24 right-4 md:bottom-8 md:right-8 bg-white/95 backdrop-blur-md p-3 rounded-2xl shadow-xl z-[1000] border border-gray-100 text-xs w-40">
                         <h4 class="font-bold mb-2 text-gray-800">Capas Activas</h4>
                         <div class="flex items-center gap-2 mb-1"><div class="w-3 h-3 rounded-full bg-orange-500"></div> <span>Restaurantes</span></div>
                         <div class="flex items-center gap-2 mb-1"><div class="w-3 h-3 rounded-full bg-purple-600"></div> <span>Museos</span></div>
                         <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-winter-900"></div> <span>Ciudades</span></div>
                    </div>
                </div>`;
            
            setTimeout(() => {
                if (window.mapInstance) window.mapInstance.remove();
                
                const map = L.map('map', { zoomControl: false }).setView([41.9028, 12.4964], 6); 
                window.mapInstance = map;
                L.control.zoom({ position: 'bottomright' }).addTo(map);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap, © CartoDB', maxZoom: 19 }).addTo(map);

                const citiesLayer = L.layerGroup().addTo(map);
                const localTripLayer = L.markerClusterGroup({ disableClusteringAtZoom: 14 }).addTo(map); 
                window.overpassLayer = L.markerClusterGroup({ disableClusteringAtZoom: 15 }).addTo(map); 

                const cityIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="w-8 h-8 bg-winter-900 text-white border-2 border-white rounded-full flex items-center justify-center shadow-xl"><i class="fas fa-city text-xs mt-0"></i></div>`, iconSize: [32, 32], iconAnchor: [16, 32] });
                const foodIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin bg-orange-500"></div><i class="fas fa-utensils text-orange-600 text-[10px]" style="margin-top: -8px; margin-left: -11px; z-index: 10;"></i>`, iconSize: [30, 42], iconAnchor: [15, 42] });
                const museumIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin" style="background: #9333ea;"></div><i class="fas fa-landmark text-purple-700 text-[10px]" style="margin-top: -8px; margin-left: -11px; z-index: 10;"></i>`, iconSize: [30, 42], iconAnchor: [15, 42] });

                tripData.route.forEach(city => {
                    L.marker(city.details.coords, {icon: cityIcon}).bindPopup(`<b>${city.name}</b><br><button onclick="router('city', '${city.id}')" class="text-blue-600 underline text-xs">Ver Guía</button>`).addTo(citiesLayer);
                    if(city.restaurants) city.restaurants.forEach(r => L.marker(r.coords, {icon: foodIcon}).bindPopup(`<b>${r.name}</b><br><span class="text-xs text-gray-500">Recomendado</span>`).addTo(localTripLayer));
                    if(city.museums) city.museums.forEach(m => L.marker(m.coords, {icon: museumIcon}).bindPopup(`<b>${m.name}</b><br><span class="text-xs text-gray-500">Museo</span>`).addTo(localTripLayer));
                });

                extraMuseumsData.forEach(m => L.marker([m.lat, m.lng], {icon: museumIcon}).bindPopup(`<b>${m.name}</b><br><span class="text-xs text-gray-500">${m.city}</span>`).addTo(localTripLayer));

                map.on('moveend', () => {
                    const btn = document.getElementById('search-here-btn');
                    if(btn) btn.classList.add('visible');
                });
            }, 100);
        }

        function renderCityCard(city) {
            return `
            <div onclick="openPreview('${city.id}')" role="button" class="bg-white rounded-2xl shadow-card hover:shadow-float p-4 cursor-pointer transition-all duration-300 transform hover:-translate-y-1 group border border-gray-100 h-full flex flex-col focus:outline-none focus:ring-2 focus:ring-warm-500">
                <div class="relative h-40 mb-4 rounded-xl overflow-hidden bg-gray-100">
                    <img src="${city.img}" loading="lazy" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                    <div class="absolute top-2 right-2 bg-white/90 backdrop-blur text-[10px] font-bold px-2 py-1 rounded shadow-sm">${city.dates.split('(')[0]}</div>
                </div>
                <div class="flex justify-between items-start mb-2"><h3 class="text-lg font-bold text-winter-900 group-hover:text-warm-600 transition-colors">${city.name}</h3></div>
                <p class="text-xs text-gray-500 line-clamp-2 mb-4 flex-1">${city.desc}</p>
                <div class="pt-3 border-t border-gray-50 flex justify-between items-center mt-auto">
                    <span class="text-[10px] text-gray-400 font-semibold uppercase tracking-wider">Ver Detalles</span>
                    <div class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-warm-500 group-hover:text-white transition-all"><i class="fas fa-arrow-right text-[10px]"></i></div>
                </div>
            </div>
            `;
        }

        function renderSplitCard(city1, city2) {
            return `
            <div onclick="router('itinerary')" role="button" class="bg-white rounded-2xl shadow-card p-5 cursor-pointer border border-gray-100 group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-warm-500 hover:shadow-lg transition-all">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-warm-500 to-red-500"></div>
                <div class="flex justify-between items-start mb-4 pl-2">
                     <div>
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Inicio & Fin</span>
                        <h3 class="text-lg font-bold text-winter-900 leading-tight mt-1">${city1.name} <span class="text-gray-300 mx-1">&</span> ${city2.name}</h3>
                     </div>
                    <div class="w-8 h-8 rounded-full bg-winter-50 flex items-center justify-center group-hover:bg-warm-500 group-hover:text-white transition-colors"><i class="fas fa-map-marked-alt text-gray-400 group-hover:text-white text-xs"></i></div>
                </div>
                <div class="relative h-32 mb-4 rounded-xl overflow-hidden flex gap-1">
                    <div class="w-1/2 relative h-full">
                        <img src="${city1.img}" class="h-full w-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2"><span class="text-white text-[10px] font-bold">${city1.name}</span></div>
                    </div>
                    <div class="w-1/2 relative h-full">
                        <img src="${city2.img}" class="h-full w-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2 text-right"><span class="text-white text-[10px] font-bold">${city2.name}</span></div>
                    </div>
                </div>
            </div>
            `;
        }
        
        function openPreview(cityId) {
            const city = tripData.route.find(c => c.id === cityId);
            if(!city) return;

            const modalContent = document.getElementById('preview-content');
            modalContent.innerHTML = `
                <div class="relative h-56 md:h-64">
                    <img src="${city.img}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                    <div class="absolute bottom-4 left-4 text-white">
                        <h2 class="text-3xl font-serif font-bold mb-1">${city.name}</h2>
                        <span class="bg-white/20 backdrop-blur px-2 py-0.5 rounded text-xs font-medium border border-white/30">${city.dates}</span>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 text-sm leading-relaxed mb-6">${city.desc}</p>
                    <button onclick="router('city', '${city.id}')" class="w-full bg-winter-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-warm-500 transition-all flex items-center justify-center gap-2">Abrir Guía Completa <i class="fas fa-external-link-alt text-xs"></i></button>
                </div>
            `;
            const modal = document.getElementById('preview-modal');
            const card = document.getElementById('preview-card');
            modal.classList.remove('hidden');
            setTimeout(() => { card.classList.remove('translate-y-full', 'scale-95'); }, 10);
        }

        function closePreview() {
            const modal = document.getElementById('preview-modal');
            const card = document.getElementById('preview-card');
            card.classList.add('translate-y-full', 'scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function toggleChat() {
            const modal = document.getElementById('chat-modal');
            modal.classList.toggle('hidden');
        }

        // --- NUEVA FUNCION: ABRE EL CHAT SIN ENVIAR NADA AUTOMATICAMENTE ---
        function openChat() {
            const modal = document.getElementById('chat-modal');
            if(modal.classList.contains('hidden')) {
                toggleChat();
                const chatBox = document.getElementById('chat-messages');
                // Si el chat está vacío, poner mensaje de bienvenida
                if(chatBox.innerHTML.trim() === '') {
                    chatBox.innerHTML += `
                        <div class="text-left mb-2 fade-in">
                            <div class="bg-white border border-gray-200 text-gray-800 py-3 px-4 rounded-xl text-sm inline-block rounded-bl-none shadow-sm">
                                <b>¡Hola! 👋 Soy tu copiloto de viaje.</b><br>
                                Conozco todo tu itinerario: hoteles, reservas, museos y fechas.<br><br>
                                <i>Pregúntame cosas como:</i><br>
                                • "¿Dónde me alojo en Roma?"<br>
                                • "¿Qué museos hay en Florencia?"<br>
                                • "Llévame al Coliseo"
                            </div>
                        </div>`;
                }
            }
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = ''; 
            await triggerMagicPrompt(text);
        }

        async function triggerMagicPrompt(text, context = 'Guía de Viajes experto') {
             const chatModal = document.getElementById('chat-modal');
             if(chatModal.classList.contains('hidden')) toggleChat();
             const chatBox = document.getElementById('chat-messages');
             chatBox.innerHTML += `<div class="text-right mb-2"><span class="bg-blue-100 text-blue-800 py-2 px-3 rounded-lg text-sm inline-block rounded-br-none">${text}</span></div>`;
             
             if (!apiKey) {
                 document.getElementById('api-warning').classList.remove('hidden');
                 return;
             }
             const loadingId = 'load-'+Date.now();
             chatBox.innerHTML += `<div id="${loadingId}" class="text-left mb-2"><span class="bg-gray-100 text-gray-500 py-2 px-3 rounded-lg text-sm inline-block rounded-bl-none"><i class="fas fa-circle-notch animate-spin"></i> Pensando...</span></div>`;
             
             // --- INYECCIÓN DE CONTEXTO ---
             // Convertimos los datos del viaje a texto para que la IA los "lea"
             const tripContext = JSON.stringify(tripData);
             const museumContext = JSON.stringify(extraMuseumsData);

             try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [{ 
                                text: `
                                    Eres un asistente de viaje personal experto para un viaje a Europa en 2026.
                                    
                                    DATOS DEL VIAJE DEL USUARIO (ÚSALOS PARA RESPONDER):
                                    ${tripContext}
                                    
                                    MUSEOS ADICIONALES:
                                    ${museumContext}

                                    INSTRUCCIONES CLAVE:
                                    1. Responde preguntas basándote en estos datos. Si preguntan por alojamiento, usa la info provista.
                                    2. Si el usuario pregunta por la ubicación de un lugar o pide ir a un sitio, GENERA SIEMPRE un enlace en formato Markdown así:
                                       [📍 Ver en Google Maps](https://www.google.com/maps/search/?api=1&query=NOMBRE_DEL_LUGAR)
                                       O para TripAdvisor:
                                       [🦉 Buscar en TripAdvisor](https://www.tripadvisor.com/Search?q=NOMBRE_DEL_LUGAR)
                                    3. Sé breve, útil y simpático.
                                    
                                    PREGUNTA DEL USUARIO:
                                    ${text}
                                ` 
                            }] 
                        }]
                    })
                });
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar eso.";
                document.getElementById(loadingId).remove();
                const formattedReply = marked.parse(reply);
                chatBox.innerHTML += `<div class="text-left mb-2"><div class="bg-white border border-gray-200 text-gray-800 py-2 px-3 rounded-lg text-sm inline-block rounded-bl-none shadow-sm prose prose-sm max-w-none">${formattedReply}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
             } catch (error) {
                 document.getElementById(loadingId).remove();
                 chatBox.innerHTML += `<div class="text-left mb-2"><span class="bg-red-100 text-red-800 py-2 px-3 rounded-lg text-sm inline-block rounded-bl-none">Error de conexión.</span></div>`;
             }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCountdown();
            setInterval(updateCountdown, 60000);
            router('home');
        });
    </script>
</body>
</html>