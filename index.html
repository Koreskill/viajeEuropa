<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EuroTrip 2026 - Planner Colaborativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        winter: {
                            50: '#F8FAFC',
                            100: '#F1F5F9', 
                            800: '#1E293B',
                            900: '#0F172A',
                        },
                        warm: {
                            500: '#F59E0B', // Amber 500
                            600: '#D97706', 
                        }
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.08)',
                        'float': '0 10px 30px -5px rgba(0, 0, 0, 0.2)',
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #F8FAFC; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Modal Backdrop Fix */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }

        /* Checkbox Custom */
        .custom-checkbox input:checked + div { background-color: #F59E0B; border-color: #F59E0B; }
        .custom-checkbox input:checked + div i { display: block; }

        /* Custom Map Icons Styles */
        .custom-icon-city { z-index: 1000 !important; }
        
        /* Iconos dinámicos */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #F59E0B;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }
        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        .custom-div-icon i {
            position: absolute;
            width: 22px;
            font-size: 22px;
            left: 0;
            right: 0;
            margin: 10px auto;
            text-align: center;
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #E2E8F0;
        }
        .timeline-item:last-child .timeline-line {
            height: 20px;
        }

        /* Animación botón buscar */
        .search-here-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(-100px);
            opacity: 0;
        }
        .search-here-btn.visible {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* File Upload Zone */
        .drop-zone {
            border: 2px dashed #CBD5E1;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #F59E0B;
            background-color: #FFFBEB;
        }
        
        /* Folder Hover Effect */
        .folder-card:hover .folder-icon {
            transform: scale(1.1);
            color: #F59E0B;
        }

        /* Status Indicator */
        #sync-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            font-size: 10px;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #e2e8f0;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #sync-status.visible { opacity: 1; }

        /* Toast Notification */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1E293B;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #toast.visible {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body class="text-winter-800 font-sans h-screen flex flex-col md:flex-row overflow-hidden bg-winter-50">

    <!-- Status Indicator -->
    <div id="sync-status" class="visible">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        <span class="text-gray-500 font-bold">En línea</span>
    </div>

    <!-- Toast Notification -->
    <div id="toast">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toast-message">Acción completada</span>
    </div>

    <!-- =======================
         NAVEGACIÓN ESCRITORIO
    ======================== -->
    <nav class="hidden md:flex flex-col w-72 bg-white border-r border-gray-200 h-full p-6 z-30 shadow-sm shrink-0" aria-label="Menú principal">
        <div class="mb-10">
            <h1 class="font-serif text-2xl font-bold text-winter-900">EuroTrip <span class="text-warm-500">2026</span></h1>
            <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest font-semibold">Planner Colaborativo</p>
        </div>
        
        <div class="space-y-2 flex-1">
            <button onclick="router('home')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="home" aria-label="Ir a Inicio">
                <i class="fas fa-compass w-5 text-center" aria-hidden="true"></i> Explorar
            </button>
            
            <button onclick="router('itinerary')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="itinerary" aria-label="Ir a Itinerario">
                <i class="fas fa-route w-5 text-center" aria-hidden="true"></i> Itinerario
            </button>

            <button onclick="router('docs')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="docs" aria-label="Ir a Documentos">
                <i class="fas fa-folder-open w-5 text-center" aria-hidden="true"></i> Documentos
            </button>

            <button onclick="router('guide')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="guide" aria-label="Ir a Guía Práctica">
                <i class="fas fa-book-open w-5 text-center" aria-hidden="true"></i> Guía Práctica
            </button>
             <button onclick="router('map')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="map" aria-label="Ir a Mapa">
                <i class="fas fa-map w-5 text-center" aria-hidden="true"></i> Mapa
            </button>
            <button onclick="router('currency')" class="nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all hover:bg-gray-50 text-gray-600 hover:text-winter-900 font-medium focus:outline-none focus:ring-2 focus:ring-warm-500" data-target="currency" aria-label="Ir a Cambio">
                <i class="fas fa-money-bill-wave w-5 text-center" aria-hidden="true"></i> Cambio
            </button>
        </div>

        <div class="mt-auto pt-6 border-t border-gray-100 space-y-3">
             <button onclick="triggerMagicPrompt('Dame una frase útil en Italiano y otra en Catalán para pedir la cuenta, con pronunciación', 'Traductor')" class="w-full bg-white border border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition-all flex items-center justify-center gap-2 font-bold text-xs focus:outline-none" aria-label="Traductor Rápido">
                <i class="fas fa-language text-warm-500" aria-hidden="true"></i> Frases Útiles ✨
            </button>
             <button onclick="openChat()" class="w-full bg-winter-900 hover:bg-warm-500 text-white py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 font-bold text-sm focus:outline-none focus:ring-4 focus:ring-warm-500/50" aria-label="Abrir Asistente IA">
                <i class="fas fa-sparkles" aria-hidden="true"></i> Asistente IA
            </button>
        </div>
    </nav>

    <!-- =======================
         HEADER MÓVIL
    ======================== -->
    <header class="md:hidden bg-white/95 backdrop-blur-md border-b border-gray-100 p-4 z-20 flex justify-between items-center shrink-0 sticky top-0">
        <div>
            <h1 class="font-serif text-lg font-bold text-winter-900">EuroTrip <span class="text-warm-500">2026</span></h1>
        </div>
        <div id="countdown-mobile" class="text-[10px] font-bold bg-gray-50 text-gray-600 px-3 py-1.5 rounded-full border border-gray-200" aria-live="polite">
            Cargando...
        </div>
    </header>

    <!-- =======================
         CONTENEDOR PRINCIPAL
    ======================== -->
    <main id="app-content" class="flex-1 overflow-y-auto overflow-x-hidden relative hide-scrollbar pb-28 md:pb-10 md:px-8 max-w-full bg-winter-50">
        <!-- El contenido se inyecta aquí -->
        <div class="flex h-full items-center justify-center">
             <div class="text-center">
                 <i class="fas fa-circle-notch fa-spin text-3xl text-warm-500 mb-4"></i>
                 <p class="text-gray-500 text-sm">Sincronizando con la nube...</p>
             </div>
        </div>
    </main>

    <!-- =======================
         NAVEGACIÓN MÓVIL
    ======================== -->
    <nav class="md:hidden bg-white/95 backdrop-blur-lg border-t border-gray-200 fixed bottom-0 w-full z-30 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.03)]" aria-label="Menú móvil">
        <div class="grid grid-cols-5 h-16 max-w-md mx-auto">
            <button onclick="router('home')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition active group" data-target="home" aria-label="Inicio">
                <i class="fas fa-compass text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Inicio</span>
            </button>
            <button onclick="router('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="itinerary" aria-label="Itinerario">
                <i class="fas fa-route text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Itinerario</span>
            </button>
             <button onclick="router('docs')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="docs" aria-label="Docs">
                <i class="fas fa-folder-open text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Docs</span>
            </button>
            <button onclick="router('map')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="map" aria-label="Mapa">
                <i class="fas fa-map text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Mapa</span>
            </button>
            <button onclick="router('guide')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-warm-500 transition group" data-target="guide" aria-label="Guía">
                <i class="fas fa-book-open text-lg mb-1" aria-hidden="true"></i><span class="text-[8px] font-semibold">Guía</span>
            </button>
        </div>
    </nav>

    <!-- =======================
         MODALES
    ======================== -->
    
    <!-- Modal Preview -->
    <div id="preview-modal" class="fixed inset-0 z-50 modal-backdrop hidden flex items-end md:items-center justify-center transition-opacity duration-300" role="dialog" aria-modal="true">
        <div class="absolute inset-0" onclick="closePreview()"></div>
        <div class="bg-white w-full md:max-w-md md:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden transform transition-transform translate-y-full md:translate-y-0 scale-95 md:scale-100 h-[85vh] md:h-auto flex flex-col relative z-10" id="preview-card">
            <button onclick="closePreview()" class="absolute top-4 right-4 z-20 bg-black/20 hover:bg-black/40 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm transition-colors focus:outline-none" aria-label="Cerrar"><i class="fas fa-times" aria-hidden="true"></i></button>
            <div id="preview-content" class="flex-1 overflow-y-auto hide-scrollbar"></div>
        </div>
    </div>

    <!-- Modal Chat IA -->
    <div id="chat-modal" class="fixed inset-0 z-50 modal-backdrop hidden flex flex-col justify-end sm:justify-center items-center" role="dialog" aria-modal="true">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-3xl h-[90vh] sm:h-[650px] flex flex-col shadow-2xl overflow-hidden relative animate-slide-up">
            <div class="bg-white border-b border-gray-100 p-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-robot text-warm-500"></i> Asistente de Viaje</h3>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Cerrar chat"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>
            <div class="p-4 bg-white border-t border-gray-100 shrink-0">
                <form onsubmit="handleChatSubmit(event)" class="flex gap-2 relative">
                    <input type="text" id="chat-input" placeholder="Pregunta algo..." class="flex-1 bg-gray-100 border-0 rounded-full px-5 py-3 text-sm focus:ring-2 focus:ring-warm-500 outline-none text-gray-800">
                    <button type="submit" class="bg-winter-900 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-warm-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-winter-900" aria-label="Enviar mensaje"><i class="fas fa-paper-plane text-xs"></i></button>
                </form>
                <p id="api-warning" class="text-[10px] text-red-500 text-center mt-2 hidden">⚠️ API Key no configurada o inválida</p>
            </div>
        </div>
    </div>
    
    <!-- Modal Config Drive -->
    <div id="drive-modal" class="fixed inset-0 z-50 modal-backdrop hidden flex items-center justify-center p-4" role="dialog" aria-modal="true">
        <div class="absolute inset-0" onclick="document.getElementById('drive-modal').classList.add('hidden')"></div>
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden relative z-10 animate-slide-up max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-winter-50">
                <div>
                    <h3 class="font-bold text-winter-900 text-lg">Configurar Enlaces de Drive</h3>
                    <p class="text-xs text-gray-500">Los cambios se guardan permanentemente en la nube.</p>
                </div>
                <button onclick="document.getElementById('drive-modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar" id="drive-config-list">
                <!-- Se llena dinamicamente -->
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 text-right">
                <button onclick="document.getElementById('drive-modal').classList.add('hidden')" class="bg-winter-900 text-white px-6 py-2 rounded-xl font-bold text-sm shadow hover:bg-warm-500 transition-colors">Listo</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Configuration (Inyectada por el entorno)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let unsubscribeSnapshot = null;
        // isFirstLoad eliminado de aquí porque ahora es global (window.isFirstLoad)

        // Autenticación y Sincronización
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        // Escuchar cambios de Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuario autenticado:", user.uid);
                setupRealtimeListener();
            }
        });

        // Configurar Listener de Firestore (Datos Compartidos)
        function setupRealtimeListener() {
            // CORREGIDO: Ruta de 6 segmentos. Estructura: artifacts/{appId}/public/data/shared_state/main
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_state', 'main');
            
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Fusionar datos remotos con estructura local
                    window.appState = { ...window.appState, ...data };
                    
                    // Actualizar UI
                    updateStatusIndicator(true);
                    if(window.isFirstLoad) { // CORREGIDO: Uso de window.isFirstLoad
                        window.isFirstLoad = false;
                        window.router('home'); // Carga inicial
                    } else {
                        // Refrescar vistas activas si es necesario
                        const currentView = document.querySelector('.nav-item.bg-winter-100')?.dataset.target;
                        if(currentView === 'docs') window.renderDocuments(document.getElementById('app-content'));
                        
                        // Si estamos dentro de una carpeta, intentar refrescarla
                        const folderTitleEl = document.getElementById('folder-title-text');
                        if (folderTitleEl) {
                             const folderContext = document.getElementById('folder-context-id')?.value;
                             const folderType = document.getElementById('folder-type-id')?.value;
                             if(folderContext) {
                                  // Recargamos la vista de carpeta
                                  const cityId = folderType === 'city_memory' ? folderContext.replace('city_', '') : null;
                                  window.renderFolderView(document.getElementById('app-content'), folderType || folderContext, cityId);
                             }
                        }
                    }
                } else {
                    // Si no existe el documento, crearlo con el estado inicial
                    console.log("Creando estado inicial compartido...");
                    setDoc(docRef, window.appState);
                    if(window.isFirstLoad) { // CORREGIDO: Uso de window.isFirstLoad
                        window.isFirstLoad = false;
                        window.router('home');
                    }
                }
            }, (error) => {
                console.error("Error sync:", error);
                updateStatusIndicator(false);
            });
        }

        // Función para guardar cambios en Firestore
        window.saveAppState = async function() {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_state', 'main');
            
            updateStatusIndicator('saving');
            try {
                await setDoc(docRef, window.appState, { merge: true });
                updateStatusIndicator(true);
            } catch (e) {
                console.error("Error saving:", e);
                updateStatusIndicator(false);
                // ALERTA VISIBLE AL USUARIO
                alert("❌ Error al sincronizar: Es posible que hayas superado el límite de tamaño de documento (1MB). Intenta borrar archivos grandes.");
            }
        };

        function updateStatusIndicator(status) {
            const el = document.getElementById('sync-status');
            if(status === 'saving') {
                el.innerHTML = '<div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div><span class="text-gray-500 font-bold">Guardando...</span>';
            } else if (status === true) {
                el.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-gray-500 font-bold">Sincronizado</span>';
            } else {
                el.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-gray-500 font-bold">Error / Offline</span>';
            }
        }

        // Iniciar
        initAuth();
    </script>

    <script>
        // --- UTILIDADES UI Y CONFIGURACIÓN GLOBAL ---
        
        // 1. CLAVE DE API (Nota: Para producción, restringe esta clave en Google Cloud Console)
        window.apiKey = "AIzaSyDhK8H4NFt5-_QEbRDuVOU49EOyeKM4FqM"; 
        
        // 2. ESTADO DE CARGA GLOBAL
        window.isFirstLoad = true; 

        // 3. ESTADO DE LA APLICACIÓN (Optimizado: Sin array de documentos pesados)
        window.appState = { 
            checkedItems: {},
            exchangeRates: { eurToArs: 1350, usdToArs: 1250, eurToUsd: 1.08 },
            cloudLinks: {} // Aquí se guardarán los enlaces a tus carpetas de Drive
        };

        function showToast(message) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            msg.innerText = message;
            toast.classList.add('visible');
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // --- DATOS ESTATICOS (MUSEOS Y VIAJE) ---
        // He minimizado esta sección visualmente, pero DEBES MANTENER TUS DATOS COMPLETOS AQUÍ.
        // No borres tu variable 'tripData' original. Aquí solo pongo el placeholder para que el código funcione.
        
        const extraMuseumsData = [
            { name: "Museos Vaticanos", lat: 41.9064, lng: 12.4547, city: "Vaticano" },
            { name: "Coliseo & Foro", lat: 41.8902, lng: 12.4922, city: "Roma" },
            { name: "Galería Uffizi", lat: 43.7678, lng: 11.2553, city: "Florencia" },
            { name: "Palacio Ducal", lat: 45.4337, lng: 12.3404, city: "Venecia" },
            { name: "Museo del Prado", lat: 40.4138, lng: -3.6921, city: "Madrid" },
            { name: "Sagrada Familia", lat: 41.4036, lng: 2.1744, city: "Barcelona" },
            { name: "La Alhambra", lat: 37.1760, lng: -3.5881, city: "Granada" },
            { name: "Real Alcázar", lat: 37.3844, lng: -5.9912, city: "Sevilla" }
        ];

        // *** IMPORTANTE: PEGA AQUÍ TU VARIABLE 'tripData' COMPLETA ORIGINAL ***
        // *** ESTOY ASUMIENDO QUE YA LA TIENES EN TU CÓDIGO ***
        // Si no la tienes, copia la del código anterior.
        // const tripData = { ... todo tu objeto enorme ... };
        
        // (Por brevedad en la respuesta, asumo que tripData existe globalmente. 
        // Si copiaste mi código anterior, tripData ya está ahí).

        // --- FUNCIONES CORE ---

        function updateCountdown() {
            if(typeof tripData === 'undefined') return;
            const now = new Date().getTime();
            const distance = tripData.startDate - now;
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const text = distance < 0 ? "¡EN VIAJE!" : `Faltan ${days} días`;
            
            const elMobile = document.getElementById("countdown-mobile");
            if(elMobile) elMobile.innerHTML = text;
        }

        function goBack(defaultRoute = 'itinerary') {
            router(defaultRoute);
        }

        function router(view, cityId = null, folderType = null) {
            // Actualizar navegación visual
            document.querySelectorAll('.nav-btn, .nav-item').forEach(btn => {
                const isActive = btn.dataset.target === view || (view === 'city' && btn.dataset.target === 'itinerary');
                if (btn.classList.contains('nav-btn')) { 
                    btn.className = `nav-btn flex flex-col items-center justify-center w-full h-full transition group ${isActive ? 'text-warm-500' : 'text-gray-400'}`;
                } else { 
                    btn.className = `nav-item w-full text-left px-4 py-3.5 rounded-xl flex items-center gap-3 transition-all font-medium focus:outline-none focus:ring-2 focus:ring-warm-500 ${isActive ? 'bg-winter-100 text-winter-900 font-bold' : 'text-gray-600 hover:bg-gray-50 hover:text-winter-900'}`;
                }
            });

            const app = document.getElementById('app-content');
            
            // Si es la carga inicial (manejada por Firebase), no hacemos nada visual aún
            if(window.isFirstLoad) return;

            app.innerHTML = ''; 
            closePreview(); 
            window.scrollTo(0,0);

            if (window.mapInstance) {
                window.mapInstance.remove();
                window.mapInstance = null;
            }

            // Enrutador
            switch(view) {
                case 'home': renderHome(app); break;
                case 'itinerary': renderItinerary(app); break;
                case 'docs': renderDocuments(app); break;
                case 'folder': renderFolderView(app, folderType, cityId); break; // Lógica nueva
                case 'guide': renderGuide(app); break;
                case 'city': 
                    renderCityFull(app, cityId); 
                    setTimeout(() => initCityMap(cityId), 300);
                    break;
                case 'map': renderMap(app); break;
                case 'currency': 
                    renderCurrency(app); 
                    fetchLiveRates(); // Llamada a la nueva API
                    break;
                default: renderHome(app);
            }
        }

        // --- RENDERIZADORES BÁSICOS ---
        // (renderHome se mantiene igual, renderItinerary también)

        function renderHome(container) {
            const rome = tripData.route[0];
            const madrid = tripData.route[tripData.route.length - 1];

            container.innerHTML = `
                <div class="p-6 md:p-0 fade-in max-w-5xl mx-auto">
                    <div class="mb-8 md:mt-6">
                        <h2 class="font-serif text-3xl md:text-4xl text-winter-900 mb-2">Hola, <span class="text-warm-500">Viajero</span></h2>
                        <p class="text-gray-600 text-sm md:text-base">Tu itinerario de 2026 está listo. Salida el 26/01.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <div class="grid grid-cols-2 gap-4">
                                <div onclick="router('itinerary')" class="bg-white p-4 rounded-2xl shadow-card border border-gray-100 cursor-pointer hover:border-warm-500 transition-colors">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-plane-arrival"></i></div>
                                        <div><h3 class="font-bold text-winter-900 text-sm">Llegada</h3><p class="text-xs text-gray-500">Roma, 26 Ene</p></div>
                                    </div>
                                </div>
                                <div onclick="router('itinerary')" class="bg-white p-4 rounded-2xl shadow-card border border-gray-100 cursor-pointer hover:border-red-500 transition-colors">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-10 h-10 bg-red-50 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-plane-departure"></i></div>
                                        <div><h3 class="font-bold text-winter-900 text-sm">Regreso</h3><p class="text-xs text-gray-500">Madrid, 21 Feb</p></div>
                                    </div>
                                </div>
                            </div>
                            <div><h3 class="font-bold text-lg mb-4 text-gray-800">Tu Ruta Principal</h3>${renderSplitCard(rome, madrid)}</div>
                        </div>
                        <div class="lg:col-span-1">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Próximas Paradas</h3>
                            <div class="space-y-0 relative pl-4 border-l-2 border-gray-200 ml-2">
                                ${tripData.route.slice(0, 5).map(city => `
                                    <div class="mb-6 pl-4 relative cursor-pointer group" onclick="openPreview('${city.id}')">
                                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-white border-2 border-warm-500 rounded-full group-hover:scale-125 transition-transform"></div>
                                        <span class="text-[10px] font-bold text-warm-500 uppercase tracking-wider block mb-1">${city.dates.split('(')[0]}</span>
                                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 group-hover:shadow-md transition-all">
                                            <h4 class="font-bold text-gray-800 text-sm">${city.name}</h4>
                                        </div>
                                    </div>`).join('')}
                                <button onclick="router('itinerary')" class="text-xs text-gray-500 font-medium hover:text-warm-500 ml-4">Ver todo →</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- GESTOR DOCUMENTAL (RENOVADO: SISTEMA DE ENLACES) ---
        
        const docCategories = [
            { id: 'vuelos', name: 'Vuelos', icon: 'fa-plane-departure', color: 'bg-blue-100 text-blue-600' },
            { id: 'reservas', name: 'Reservas', icon: 'fa-hotel', color: 'bg-purple-100 text-purple-600' },
            { id: 'entradas', name: 'Entradas', icon: 'fa-ticket-alt', color: 'bg-pink-100 text-pink-600' },
            { id: 'transporte', name: 'Transporte', icon: 'fa-train', color: 'bg-green-100 text-green-600' },
            { id: 'seguro', name: 'Seguro', icon: 'fa-file-medical', color: 'bg-red-100 text-red-600' },
            { id: 'identificaciones', name: 'Identificaciones', icon: 'fa-id-card', color: 'bg-orange-100 text-orange-600' }
        ];

        function renderDocuments(container) {
            // Renderizado de Carpetas Generales
            const foldersHTML = docCategories.map(cat => {
                const isLinked = appState.cloudLinks[cat.name] ? true : false;
                return `
                <div onclick="router('folder', null, '${cat.name}')" class="folder-card bg-white p-5 rounded-2xl shadow-card border border-gray-100 cursor-pointer transition-all hover:shadow-lg flex flex-col items-center justify-center text-center gap-3 h-32 md:h-40 relative group hover:-translate-y-1">
                     ${isLinked ? '<div class="absolute top-3 right-3 text-green-500 animate-pulse bg-green-50 rounded-full px-1.5 py-0.5 text-[10px] font-bold border border-green-100"><i class="fas fa-link"></i></div>' : ''}
                    <div class="w-12 h-12 rounded-full ${cat.color} flex items-center justify-center folder-icon transition-transform duration-300 group-hover:scale-110">
                        <i class="fas ${cat.icon} text-xl"></i>
                    </div>
                    <div>
                        <span class="font-bold text-gray-700 text-sm block">${cat.name}</span>
                        <span class="text-[9px] text-gray-400">${isLinked ? 'Drive Conectado' : 'Local'}</span>
                    </div>
                </div>
            `}).join('');

            // Renderizado de Ciudades (Galería)
            const citiesHTML = tripData.route.map(city => {
                const key = 'city_' + city.id;
                const isLinked = appState.cloudLinks[key] ? true : false;
                return `
                <div onclick="router('folder', '${city.id}', 'city_memory')" class="relative rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all cursor-pointer h-24 md:h-32 group hover:-translate-y-1">
                    <img src="${city.img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://placehold.co/600x400?text=${city.name}'">
                    <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                        <h4 class="text-white font-bold text-sm shadow-black drop-shadow-md text-center px-2">${city.name}</h4>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center text-[10px] ${isLinked ? 'bg-green-500 text-white' : 'bg-white/90 text-gray-400'} shadow-sm">
                        <i class="fab fa-google-drive"></i>
                    </div>
                </div>
            `}).join('');

            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto">
                    <div class="mb-8 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl font-serif font-bold text-winter-900 mb-2">Documentación</h2>
                            <p class="text-gray-600 text-sm">Gestiona tus enlaces a Google Drive.</p>
                        </div>
                        <button onclick="openDriveConfig()" class="bg-winter-900 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-warm-500 transition-colors flex items-center gap-2 shadow-lg hover:shadow-xl transform active:scale-95">
                            <i class="fas fa-cog"></i> Configurar Nube
                        </button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-10">
                        ${foldersHTML}
                    </div>

                    <div class="mb-6 border-t border-gray-200 pt-8">
                         <div class="flex items-center gap-3 mb-6">
                             <div class="p-2 bg-yellow-100 rounded-lg text-yellow-600"><i class="fas fa-images"></i></div>
                             <div>
                                <h3 class="text-xl font-bold text-gray-800">Memorias de Viaje</h3>
                                <p class="text-xs text-gray-500">Enlaces a carpetas de fotos por ciudad.</p>
                             </div>
                         </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${citiesHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CONFIGURADOR DE LINKS (NUEVO) ---
        function openDriveConfig() {
            const list = document.getElementById('drive-config-list');
            list.innerHTML = '';
            
            list.innerHTML += `
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl mb-6 text-xs text-blue-800 flex gap-3">
                    <i class="fas fa-info-circle text-lg mt-1"></i>
                    <div>
                        <p class="font-bold mb-1">¿Cómo funciona?</p>
                        <p>1. Crea una carpeta en Google Drive / Dropbox.</p>
                        <p>2. Copia el enlace "Compartir".</p>
                        <p>3. Pégalo aquí abajo para que todos tengan acceso rápido.</p>
                    </div>
                </div>
            `;

            // Inputs Categorías
            list.innerHTML += `<h4 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wider border-b border-gray-100 pb-2">Documentos</h4>`;
            docCategories.forEach(cat => {
                const val = appState.cloudLinks[cat.name] || '';
                list.innerHTML += `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 flex items-center gap-2"><i class="fas ${cat.icon}"></i> ${cat.name}</label>
                        <input type="url" placeholder="https://drive.google.com/..." 
                               value="${val}" 
                               onchange="saveCloudLink('${cat.name}', this.value)"
                               class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-warm-500 outline-none transition-all">
                    </div>
                `;
            });

            // Inputs Ciudades
            list.innerHTML += `<h4 class="font-bold text-gray-800 mb-3 mt-6 text-sm uppercase tracking-wider border-b border-gray-100 pb-2">Fotos por Ciudad</h4>`;
            tripData.route.forEach(city => {
                const key = 'city_' + city.id;
                const val = appState.cloudLinks[key] || '';
                list.innerHTML += `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">${city.name}</label>
                        <div class="flex gap-2">
                             <input type="url" placeholder="Enlace carpeta fotos ${city.name}..." 
                                    value="${val}" 
                                    onchange="saveCloudLink('${key}', this.value)"
                                    class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-warm-500 outline-none transition-all">
                        </div>
                    </div>
                `;
            });

            document.getElementById('drive-modal').classList.remove('hidden');
        }

        async function saveCloudLink(id, url) {
            appState.cloudLinks[id] = url;
            updateStatusIndicator('saving');
            await saveAppState(); 
            showToast("Enlace guardado exitosamente");
        }

        // --- VISTA DETALLE CARPETA (PORTAL A DRIVE) ---
        function renderFolderView(container, folderType, cityId) {
            let title = folderType;
            let context = folderType;
            let icon = 'fa-folder-open';
            let subtitle = "Documentos y Archivos";

            if (folderType === 'city_memory' && cityId) {
                const city = tripData.route.find(c => c.id === cityId);
                title = city ? city.name : 'Ciudad';
                context = `city_${cityId}`; 
                icon = 'fa-camera-retro';
                subtitle = "Galería y Recuerdos";
            }

            const externalLink = appState.cloudLinks[context];

            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-2xl mx-auto h-full flex flex-col items-center justify-center min-h-[60vh]">
                    
                    <div class="w-full flex justify-start mb-4">
                        <button onclick="router('docs')" class="flex items-center gap-2 text-gray-500 hover:text-warm-500 transition-colors text-sm font-bold px-4 py-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-arrow-left"></i> Volver a Documentos
                        </button>
                    </div>

                    <div class="bg-white w-full rounded-3xl shadow-xl border border-gray-100 p-8 md:p-12 text-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-warm-100 rounded-full opacity-50 -mr-10 -mt-10 blur-xl"></div>
                        <div class="absolute bottom-0 left-0 w-32 h-32 bg-blue-100 rounded-full opacity-50 -ml-10 -mb-10 blur-xl"></div>
                        
                        <div class="relative z-10">
                            <div class="w-24 h-24 bg-winter-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner text-winter-900 text-4xl">
                                <i class="fas ${icon}"></i>
                            </div>
                            
                            <h2 class="text-3xl font-serif font-bold text-winter-900 mb-2 capitalize">${title}</h2>
                            <p class="text-gray-500 mb-8">${subtitle}</p>

                            ${externalLink 
                                ? `
                                <a href="${externalLink}" target="_blank" class="block w-full bg-gradient-to-r from-winter-900 to-winter-800 hover:from-warm-500 hover:to-warm-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex items-center justify-center gap-3 group">
                                    <i class="fab fa-google-drive text-2xl group-hover:animate-bounce"></i> 
                                    <span>Abrir Carpeta en la Nube</span>
                                </a>
                                <p class="mt-4 text-xs text-green-600 flex items-center justify-center gap-1 font-semibold">
                                    <i class="fas fa-check-circle"></i> Enlace Sincronizado
                                </p>
                                ` 
                                : `
                                <div class="bg-red-50 border border-red-100 rounded-xl p-4 mb-6">
                                    <p class="text-red-600 font-bold text-sm">Enlace no configurado</p>
                                    <p class="text-red-400 text-xs mt-1">Añade la URL de Drive para acceder.</p>
                                </div>
                                <button onclick="openDriveConfig()" class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 py-4 rounded-xl font-bold hover:border-warm-500 hover:text-warm-500 hover:bg-warm-50 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-link"></i> Configurar Enlace Ahora
                                </button>
                                `
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // --- COTIZADOR (ACTUALIZADO CON TUS LINKS) ---
        
        function renderCurrency(container) {
            container.innerHTML = `
                <div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-xl mx-auto">
                    <div class="mb-8 text-center md:text-left">
                         <div class="flex items-center justify-between">
                            <h2 class="text-3xl font-serif font-bold text-winter-900 mb-2">Calculadora</h2>
                            <button onclick="document.getElementById('rates-config').classList.toggle('hidden')" class="text-warm-500 text-sm font-bold bg-warm-50 px-3 py-1 rounded-full hover:bg-warm-100 transition-colors"><i class="fas fa-cog"></i></button>
                        </div>
                        <p class="text-gray-600 text-sm">Cambio en tiempo real.</p>
                    </div>

                    <div id="cotizaciones" class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-2xl border border-green-100 flex flex-col items-center justify-center text-center shadow-sm">
                            <span class="text-[10px] font-bold text-green-600 uppercase tracking-wider mb-1">Dólar Blue (Venta)</span>
                            <div class="flex items-center gap-1 text-green-800">
                                <span id="dh-dolar" class="text-2xl font-bold">Cargando...</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex flex-col items-center justify-center text-center shadow-sm">
                            <span class="text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-1">Euro (Venta)</span>
                            <div class="flex items-center gap-1 text-blue-800">
                                <span id="dh-euro" class="text-2xl font-bold">Cargando...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Config Manual Oculta -->
                    <div id="rates-config" class="hidden mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200 animate-slide-up">
                        <h4 class="font-bold text-gray-700 mb-3 text-xs uppercase">Configurar Manualmente</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] block mb-1">EURO</label><input type="number" id="rate-eur" value="${appState.exchangeRates.eurToArs}" onchange="updateRates()" class="w-full p-2 border rounded"></div>
                            <div><label class="text-[10px] block mb-1">DÓLAR</label><input type="number" id="rate-usd" value="${appState.exchangeRates.usdToArs}" onchange="updateRates()" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>

                    <!-- Calculadora -->
                    <div class="space-y-4">
                        <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-winter-900 relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Peso Argentino (ARS)</label>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl text-winter-900 font-serif">$</span>
                                <input type="number" id="input-ars" placeholder="0" oninput="calculateCurrency('ars')" class="w-full text-3xl font-bold text-gray-800 outline-none">
                                <img src="https://flagcdn.com/w40/ar.png" class="w-8 h-auto opacity-80 rounded shadow-sm">
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-blue-500 relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Euro (EUR)</label>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl text-blue-600 font-serif">€</span>
                                <input type="number" id="input-eur" placeholder="0" oninput="calculateCurrency('eur')" class="w-full text-3xl font-bold text-gray-800 outline-none">
                                <img src="https://flagcdn.com/w40/eu.png" class="w-8 h-auto opacity-80 rounded shadow-sm">
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-green-500 relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Dólar (USD)</label>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl text-green-600 font-serif">$</span>
                                <input type="number" id="input-usd" placeholder="0" oninput="calculateCurrency('usd')" class="w-full text-3xl font-bold text-gray-800 outline-none">
                                <img src="https://flagcdn.com/w40/us.png" class="w-8 h-auto opacity-80 rounded shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchLiveRates() {
             const elDolar = document.getElementById("dh-dolar");
             const elEuro = document.getElementById("dh-euro");
             if(!elDolar || !elEuro) return; 

             elDolar.innerText = "...";
             elEuro.innerText = "...";

             try {
                // LLAMADAS EN PARALELO A LOS LINKS SOLICITADOS
                const [dolarRes, euroRes] = await Promise.all([
                    fetch('https://dolarapi.com/v1/dolares/blue'), // Link 1 solicitado
                    fetch('https://dolarapi.com/v1/cotizaciones/eur') // Link 2 solicitado
                ]);

                if (!dolarRes.ok || !euroRes.ok) throw new Error('API Error');

                const dolarData = await dolarRes.json();
                const euroData = await euroRes.json();

                // EXTRAEMOS 'VENTA' COMO SE SOLICITÓ
                const valUsd = parseFloat(dolarData.venta) || 1250;
                const valEur = parseFloat(euroData.venta) || 1350;

                // Actualizar UI
                elDolar.innerText = `$ ${valUsd}`;
                elEuro.innerText = `$ ${valEur}`;

                // Actualizar Inputs Ocultos y Estado Global
                const inputUsd = document.getElementById('rate-usd');
                if(inputUsd) inputUsd.value = valUsd;
                const inputEur = document.getElementById('rate-eur');
                if(inputEur) inputEur.value = valEur;

                appState.exchangeRates.usdToArs = valUsd;
                appState.exchangeRates.eurToArs = valEur;
                // Guardamos solo si el usuario está autenticado, para no spammear la BD en cada refresh
                if (auth.currentUser) saveAppState();
            } catch (error) {
                console.error("Error fetching rates:", error);
                // Fallback a valores guardados
                elDolar.innerText = `$ ${appState.exchangeRates.usdToArs}`;
                elEuro.innerText = `$ ${appState.exchangeRates.eurToArs}`;
            }
        }

        function updateRates() {
            const newEur = parseFloat(document.getElementById('rate-eur').value) || 1350;
            const newUsd = parseFloat(document.getElementById('rate-usd').value) || 1250;
            saveExchangeRates({ eurToArs: newEur, usdToArs: newUsd, eurToUsd: newEur / newUsd });
            if(document.getElementById('input-ars').value) calculateCurrency('ars');
        }

        function saveExchangeRates(newRates) {
            appState.exchangeRates = { ...appState.exchangeRates, ...newRates };
            saveAppState();
        }

        function calculateCurrency(source) {
            const arsInput = document.getElementById('input-ars');
            const eurInput = document.getElementById('input-eur');
            const usdInput = document.getElementById('input-usd');
            const rates = appState.exchangeRates;
            let val = 0;

            if (source === 'ars') {
                val = parseFloat(arsInput.value);
                if (isNaN(val)) { eurInput.value = ''; usdInput.value = ''; return; }
                eurInput.value = (val / rates.eurToArs).toFixed(2);
                usdInput.value = (val / rates.usdToArs).toFixed(2);
            } else if (source === 'eur') {
                val = parseFloat(eurInput.value);
                if (isNaN(val)) { arsInput.value = ''; usdInput.value = ''; return; }
                arsInput.value = (val * rates.eurToArs).toFixed(0);
                usdInput.value = (val * (rates.eurToArs / rates.usdToArs)).toFixed(2);
            } else if (source === 'usd') {
                val = parseFloat(usdInput.value);
                if (isNaN(val)) { arsInput.value = ''; eurInput.value = ''; return; }
                arsInput.value = (val * rates.usdToArs).toFixed(0);
                eurInput.value = (val * (rates.eurToArs / rates.eurToArs)).toFixed(2);
            }
        }

        // --- AUXILIARES (Checklists, Render Split Card, etc) ---
        // Se mantienen casi igual, solo asegurando consistencia.

        function saveCheckState(id, isChecked) {
            appState.checkedItems[id] = isChecked;
            saveAppState();
        }

        function renderSplitCard(city1, city2) {
            return `
            <div onclick="router('itinerary')" class="bg-white rounded-2xl shadow-card p-5 cursor-pointer border border-gray-100 group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-warm-500 hover:shadow-lg transition-all">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-warm-500 to-red-500"></div>
                <div class="flex justify-between items-start mb-4 pl-2">
                     <div>
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Inicio & Fin</span>
                        <h3 class="text-lg font-bold text-winter-900 leading-tight mt-1">${city1.name} <span class="text-gray-300 mx-1">&</span> ${city2.name}</h3>
                     </div>
                    <div class="w-8 h-8 rounded-full bg-winter-50 flex items-center justify-center group-hover:bg-warm-500 group-hover:text-white transition-colors"><i class="fas fa-map-marked-alt text-gray-400 group-hover:text-white text-xs"></i></div>
                </div>
                <div class="relative h-32 mb-4 rounded-xl overflow-hidden flex gap-1">
                    <div class="w-1/2 relative h-full">
                        <img src="${city1.img}" class="h-full w-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2"><span class="text-white text-[10px] font-bold">${city1.name}</span></div>
                    </div>
                    <div class="w-1/2 relative h-full">
                        <img src="${city2.img}" class="h-full w-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2 text-right"><span class="text-white text-[10px] font-bold">${city2.name}</span></div>
                    </div>
                </div>
            </div>`;
        }

        function openPreview(cityId) {
            const city = tripData.route.find(c => c.id === cityId);
            if(!city) return;
            const modalContent = document.getElementById('preview-content');
            modalContent.innerHTML = `
                <div class="relative h-56 md:h-64">
                    <img src="${city.img}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                    <div class="absolute bottom-4 left-4 text-white">
                        <h2 class="text-3xl font-serif font-bold mb-1">${city.name}</h2>
                        <span class="bg-white/20 backdrop-blur px-2 py-0.5 rounded text-xs font-medium border border-white/30">${city.dates}</span>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 text-sm leading-relaxed mb-6">${city.desc}</p>
                    <button onclick="router('city', '${city.id}')" class="w-full bg-winter-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-warm-500 transition-all flex items-center justify-center gap-2">Abrir Guía Completa <i class="fas fa-external-link-alt text-xs"></i></button>
                </div>
            `;
            const modal = document.getElementById('preview-modal');
            const card = document.getElementById('preview-card');
            modal.classList.remove('hidden');
            setTimeout(() => { card.classList.remove('translate-y-full', 'scale-95'); }, 10);
        }

        function closePreview() {
            const modal = document.getElementById('preview-modal');
            const card = document.getElementById('preview-card');
            card.classList.add('translate-y-full', 'scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- CHAT IA (Mantenido) ---
        function toggleChat() { document.getElementById('chat-modal').classList.toggle('hidden'); }
        function openChat() {
            const modal = document.getElementById('chat-modal');
            if(modal.classList.contains('hidden')) {
                toggleChat();
                const chatBox = document.getElementById('chat-messages');
                if(chatBox.innerHTML.trim() === '') {
                    chatBox.innerHTML += `<div class="text-left mb-2 fade-in"><div class="bg-white border border-gray-200 text-gray-800 py-3 px-4 rounded-xl text-sm inline-block rounded-bl-none shadow-sm"><b>¡Hola! 👋 Soy tu copiloto.</b><br>Pregúntame sobre itinerarios, museos o consejos.</div></div>`;
                }
            }
        }
        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = ''; 
            await triggerMagicPrompt(text);
        }
        async function triggerMagicPrompt(text) {
             const chatModal = document.getElementById('chat-modal');
             if(chatModal.classList.contains('hidden')) toggleChat();
             const chatBox = document.getElementById('chat-messages');
             chatBox.innerHTML += `<div class="text-right mb-2"><span class="bg-blue-100 text-blue-800 py-2 px-3 rounded-lg text-sm inline-block rounded-br-none">${text}</span></div>`;
             
             if (!apiKey) {
                 document.getElementById('api-warning').classList.remove('hidden');
                 return;
             }
             const loadingId = 'load-'+Date.now();
             chatBox.innerHTML += `<div id="${loadingId}" class="text-left mb-2"><span class="bg-gray-100 text-gray-500 py-2 px-3 rounded-lg text-sm inline-block rounded-bl-none"><i class="fas fa-circle-notch animate-spin"></i> Pensando...</span></div>`;
             
             try {
                // Generamos contexto minimo para ahorrar tokens
                const context = `Eres un guía para un viaje a Europa 2026. Datos: ${JSON.stringify(tripData.route.map(c=>({n:c.name,d:c.dates,h:c.accommodation?.name})))}. Responde breve.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `${context} Usuario pregunta: ${text}` }] }] })
                });
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error en IA.";
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="text-left mb-2"><div class="bg-white border border-gray-200 text-gray-800 py-2 px-3 rounded-lg text-sm inline-block rounded-bl-none shadow-sm prose prose-sm max-w-none">${marked.parse(reply)}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
             } catch (error) {
                 document.getElementById(loadingId).remove();
                 chatBox.innerHTML += `<div class="text-left mb-2"><span class="bg-red-100 text-red-800 py-2 px-3 rounded-lg text-sm inline-block rounded-bl-none">Error de red.</span></div>`;
             }
        }

        // --- MAPAS (Mantenido y Optimizado) ---
        function initCityMap(cityId) {
            const city = tripData.route.find(c => c.id === cityId);
            if(!city || !city.details.coords) return;
            const mapId = `city-map-${cityId}`;
            if(!document.getElementById(mapId)) return;
            if(window.cityMapInstance) window.cityMapInstance.remove();
            const map = L.map(mapId, { zoomControl: false }).setView(city.details.coords, 14);
            window.cityMapInstance = map;
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map);
            const pinHtml = col => `<div class="marker-pin" style="background:${col}"></div><i class="fas fa-map-marker-alt text-white text-[10px]" style="margin-top:-8px;margin-left:-11px;z-index:10;position:absolute"></i>`;
            const icon = (col) => L.divIcon({ className: 'custom-div-icon', html: pinHtml(col), iconSize: [30, 42], iconAnchor: [15, 42] });
            if(city.museums) city.museums.forEach(m => L.marker(m.coords, {icon: icon('#9333ea')}).bindPopup(m.name).addTo(map));
            if(city.restaurants) city.restaurants.forEach(r => L.marker(r.coords, {icon: icon('#f97316')}).bindPopup(r.name).addTo(map));
        }

        function renderCityCard(city) {
            return `
            <div onclick="openPreview('${city.id}')" class="bg-white rounded-2xl shadow-card hover:shadow-float p-4 cursor-pointer transition-all duration-300 transform hover:-translate-y-1 group border border-gray-100 h-full flex flex-col focus:outline-none focus:ring-2 focus:ring-warm-500">
                <div class="relative h-40 mb-4 rounded-xl overflow-hidden bg-gray-100">
                    <img src="${city.img}" loading="lazy" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                    <div class="absolute top-2 right-2 bg-white/90 backdrop-blur text-[10px] font-bold px-2 py-1 rounded shadow-sm">${city.dates.split('(')[0]}</div>
                </div>
                <div class="flex justify-between items-start mb-2"><h3 class="text-lg font-bold text-winter-900 group-hover:text-warm-600 transition-colors">${city.name}</h3></div>
                <p class="text-xs text-gray-500 line-clamp-2 mb-4 flex-1">${city.desc}</p>
                <div class="pt-3 border-t border-gray-50 flex justify-between items-center mt-auto">
                    <span class="text-[10px] text-gray-400 font-semibold uppercase tracking-wider">Ver Detalles</span>
                    <div class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-warm-500 group-hover:text-white transition-all"><i class="fas fa-arrow-right text-[10px]"></i></div>
                </div>
            </div>`;
        }

        function renderCityFull(container, cityId) {
            const city = tripData.route.find(c => c.id === cityId);
            if(!city) return renderHome(container);

            const timelineHTML = city.dailyItinerary ? city.dailyItinerary.map(day => `
                <div class="timeline-item relative pl-8 pb-8">
                    <div class="timeline-line"></div>
                    <div class="absolute left-0 top-0 w-8 h-8 rounded-full bg-warm-100 border-2 border-warm-500 flex items-center justify-center text-xs font-bold text-warm-600 shadow-sm z-10">${day.date.split('/')[0]}</div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 ml-2">
                        <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-winter-900 text-lg">${day.title}</h4>
                        ${day.mapLink ? `<a href="${day.mapLink}" target="_blank" class="text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-xs font-bold"><i class="fas fa-map-marked-alt"></i> Ruta</a>` : ''}</div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <p>🌞 ${day.morning}</p><p>🍝 ${day.afternoon}</p><p>🌙 ${day.night}</p>
                        </div>
                    </div>
                </div>`).join('') : '';

            const mustDoHTML = city.details.mustDo.map((item, i) => {
                const uniqueId = `${cityId}-mustdo-${i}`;
                const isChecked = appState.checkedItems[uniqueId] ? 'checked' : '';
                return `
                <label class="custom-checkbox flex items-start gap-3 p-3 bg-white border border-gray-100 rounded-xl cursor-pointer shadow-sm hover:border-warm-200 transition-all select-none">
                    <input type="checkbox" class="hidden" ${isChecked} onchange="saveCheckState('${uniqueId}', this.checked)">
                    <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center bg-white transition-colors shrink-0 mt-0.5"><i class="fas fa-check text-white text-[10px] hidden"></i></div>
                    <span class="text-sm text-gray-700 font-medium">${item}</span>
                </label>`;
            }).join('');

            container.innerHTML = `
                <div class="pb-20 fade-in bg-white min-h-full">
                    <div class="relative h-[30vh] md:h-[35vh] w-full overflow-hidden">
                        <img src="${city.img}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-winter-900/90 via-transparent to-transparent"></div>
                        <button onclick="goBack('itinerary')" class="absolute top-4 left-4 z-20 bg-white/20 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center border border-white/30"><i class="fas fa-arrow-left"></i></button>
                        <div class="absolute bottom-0 left-0 w-full p-6 text-white">
                            <div class="max-w-6xl mx-auto">
                                <span class="bg-warm-500 text-white px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider mb-2 inline-block">${city.dates}</span>
                                <h1 class="text-3xl md:text-5xl font-serif font-bold mb-2">${city.name}</h1>
                            </div>
                        </div>
                    </div>
                    <div class="max-w-6xl mx-auto px-4 py-8 relative z-10">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 space-y-8">
                                <div><h3 class="font-bold text-winter-900 text-lg mb-6 border-b border-gray-100 pb-2">Itinerario</h3><div class="relative pl-2">${timelineHTML}</div></div>
                                <div><h3 class="font-bold text-winter-900 text-lg mb-4">Mapa</h3><div id="city-map-${cityId}" class="w-full h-64 rounded-xl shadow-inner border border-gray-200"></div></div>
                                <div><h3 class="font-bold text-winter-900 text-lg mb-4">Comer</h3><div class="bg-orange-50 rounded-xl p-5 text-orange-900 text-sm italic"><i class="fas fa-quote-left text-orange-200 text-2xl mr-2"></i>${city.details.eat}</div></div>
                            </div>
                            <div class="md:col-span-1 space-y-6">
                                ${city.accommodation ? `<div class="bg-winter-900 rounded-xl shadow-lg p-5 text-white"><h3 class="font-bold text-sm uppercase text-gray-400 mb-3">Alojamiento</h3><p class="font-serif text-lg">${city.accommodation.name}</p><p class="text-xs text-gray-400 mt-1">${city.accommodation.address}</p></div>` : ''}
                                <div class="bg-white rounded-xl shadow-card p-5 border border-gray-100"><h3 class="font-bold text-gray-800 mb-4 text-sm uppercase border-b border-gray-50 pb-2">Imperdibles</h3><div class="space-y-2">${mustDoHTML}</div></div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderGuide(container) {
            const categories = tripData.guide.map(cat => `
                <div class="bg-white rounded-2xl shadow-card overflow-hidden border border-gray-100 mb-6 break-inside-avoid">
                    <div class="p-4 ${cat.bg} border-b border-gray-100 flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm ${cat.color}"><i class="fas ${cat.icon}"></i></div><h3 class="font-bold text-winter-900 text-lg">${cat.title}</h3></div>
                    <div class="p-5 divide-y divide-gray-50">${cat.items.map(i => `<div class="py-3"><h4 class="text-sm font-bold text-winter-900 mb-1">✓ ${i.t}</h4><p class="text-xs text-gray-700 pl-4">${i.d}</p></div>`).join('')}</div>
                </div>`).join('');
            container.innerHTML = `<div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto"><h2 class="text-3xl font-serif font-bold text-winter-900 mb-6">Guía Práctica</h2><div class="columns-1 md:columns-2 gap-6 space-y-6">${categories}</div></div>`;
        }

        function renderItinerary(container) {
            const gridHTML = tripData.route.map(city => renderCityCard(city)).join('');
            container.innerHTML = `<div class="pt-6 px-4 md:px-0 fade-in pb-20 max-w-6xl mx-auto"><h2 class="text-4xl font-serif font-bold text-winter-900 mb-8">Itinerario Completo</h2><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${gridHTML}</div></div>`;
        }

        function renderMap(container) {
            container.innerHTML = `
                <div class="h-full w-full relative fade-in">
                    <div id="map" class="h-full w-full bg-gray-200 z-10"></div>
                </div>`;
            setTimeout(() => {
                if (window.mapInstance) window.mapInstance.remove();
                const map = L.map('map', { zoomControl: false }).setView([41.9028, 12.4964], 6); 
                window.mapInstance = map;
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
                
                const cluster = L.markerClusterGroup();
                const cityIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="w-8 h-8 bg-winter-900 text-white border-2 border-white rounded-full flex items-center justify-center shadow-xl"><i class="fas fa-city text-xs mt-0"></i></div>`, iconSize: [32, 32] });
                
                tripData.route.forEach(city => {
                    L.marker(city.details.coords, {icon: cityIcon}).bindPopup(`<b>${city.name}</b>`).addTo(map);
                    // Aquí podrías añadir los museos y restaurantes al cluster si quisieras
                });
                map.addLayer(cluster);
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCountdown();
            setInterval(updateCountdown, 60000);
        });
    </script>
</body>
</html>